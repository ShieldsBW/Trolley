<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trolley Problem Prototype</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
  <style>
    :root {
      --vh: 1vh; /* Will be set by JS to actual viewport height */
    }
    html, body {
      margin: 0;
      padding: 0;
      height: calc(var(--vh, 1vh) * 100);
      overflow: hidden;
    }
    canvas { display: block; margin: 0 auto; }

    /* Debug outline styles - only visible when body has debug-active class */
    /* Frames - red */
    body.debug-active [id*="frame"],
    body.debug-active [id*="Frame"] { outline: 1px solid red !important; }
    /* Safe areas - lime */
    body.debug-active [id*="safe-area"],
    body.debug-active [id*="Safe"] { outline: 1px solid lime !important; }
    /* Buttons - cyan */
    body.debug-active [id*="btn-"],
    body.debug-active [id*="tab-"],
    body.debug-active button { outline: 1px solid cyan !important; }
    /* Text elements - yellow */
    body.debug-active [id*="text"],
    body.debug-active [id*="Text"],
    body.debug-active [id*="-desc"],
    body.debug-active [id*="-name"],
    body.debug-active p { outline: 1px solid yellow !important; }
    /* Containers - magenta */
    body.debug-active [id*="container"],
    body.debug-active [id*="Container"],
    body.debug-active [id*="-content"],
    body.debug-active [id*="items"] { outline: 1px solid magenta !important; }
    /* Logo - orange */
    body.debug-active [id*="logo"],
    body.debug-active [id*="Logo"] { outline: 1px solid orange !important; }
    /* Welcome/currency display - white */
    body.debug-active [id*="welcome"],
    body.debug-active [id*="currency"] { outline: 1px solid white !important; }
    /* Titles/headings - coral */
    body.debug-active [id*="title"],
    body.debug-active [id*="Title"],
    body.debug-active h1,
    body.debug-active h2 { outline: 1px solid coral !important; }
    /* Zone elements - gold */
    body.debug-active [id*="zone-detail"],
    body.debug-active [id*="zone-marker"],
    body.debug-active .zone-marker { outline: 1px solid gold !important; }
    /* Shop elements - violet */
    body.debug-active [id*="shop-"],
    body.debug-active [id*="profile-"] { outline: 1px solid violet !important; }
    /* Progress bars - springgreen */
    body.debug-active [id*="progress"] { outline: 1px solid springgreen !important; }
    /* Item bar elements - deepskyblue */
    body.debug-active [id*="item-"] { outline: 1px solid deepskyblue !important; }
    /* Leaderboard elements - lightsalmon */
    body.debug-active [id*="leaderboard-"] { outline: 1px solid lightsalmon !important; }
    /* Consequence elements - tomato */
    body.debug-active [id*="consequence-"] { outline: 1px solid tomato !important; }
    /* HUD elements - dodgerblue */
    body.debug-active [id*="hud-"],
    body.debug-active #game-hud { outline: 1px solid dodgerblue !important; }
    /* Game Over elements - limegreen */
    body.debug-active [id*="go-"],
    body.debug-active #go-total-points,
    body.debug-active #go-btn-container { outline: 1px solid limegreen !important; }

    /* Zone Complete popup animation */
    @keyframes zoneCompleteScaleIn {
      from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    .zone-complete-animate {
      animation: zoneCompleteScaleIn 0.4s ease-out forwards;
    }

    /* Difficulty selector styles */
    .difficulty-btn {
      width: 36px;
      height: 36px;
      border: 2px solid #666;
      border-radius: 8px;
      background: rgba(0,0,0,0.5);
      color: #aaa;
      font-family: Arial, sans-serif;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      margin: 0 4px;
    }
    .difficulty-btn:hover:not(.locked) {
      border-color: #FFD700;
      color: #FFD700;
    }
    .difficulty-btn.selected {
      border-color: #FFD700;
      background: rgba(255, 215, 0, 0.3);
      color: #FFD700;
    }
    .difficulty-btn.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }

    #debug-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      background: rgba(255,255,255,0.3);
      border: 1px solid rgba(255,255,255,0.5);
      border-radius: 4px;
      cursor: pointer;
      z-index: 9999;
      font-size: 16px;
      line-height: 28px;
      text-align: center;
      user-select: none;
    }
    #debug-btn:hover { background: rgba(255,255,255,0.5); }
    #debug-btn:active { background: rgba(255,255,255,0.7); }
  </style>
</head>
<body>
<!-- Debug button - hold to show outlines -->
<div id="debug-btn" title="Hold to show debug outlines">üîç</div>

<img id="menu-bg" src="assets/backgrounds/menu_bg.png" alt="" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);object-fit:cover;z-index:-1;display:none;"/>
<img id="level-bg" src="assets/backgrounds/level_01_background.png" alt="" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);object-fit:cover;z-index:-1;display:none;"/>
<!-- Leaderboard Scene Elements -->
<div id="leaderboard-container" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);display:none;z-index:100;">
  <!-- Leaderboard frame - centered -->
  <div id="leaderboard-frame" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:calc(var(--vh, 1vh) * 90 * 0.64);height:calc(var(--vh, 1vh) * 90);">
    <!-- Frame image layer (aspect ratio 944:1472 = 0.64:1) -->
    <img src="assets/frames/frame_leaderboard.png" style="position:absolute;inset:0;width:100%;height:100%;object-fit:fill;pointer-events:none;"/>
    <!-- Safe area for content (insets: top 15%, right 15%, bottom 15%, left 15%) -->
    <div id="leaderboard-safe-area" style="position:absolute;top:15%;left:15%;right:15%;bottom:15%;display:flex;flex-direction:column;align-items:center;overflow:hidden;">
      <h1 id="leaderboard-title" style="color:#fff;font-family:Arial,sans-serif;font-size:clamp(24px, 5vh, 48px);margin:0 0 2vh 0;">Leaderboard</h1>
      <div id="leaderboard-entries" style="width:100%;flex:1;display:flex;flex-direction:column;justify-content:flex-start;gap:1vh;overflow:hidden;"></div>
      <div id="leaderboard-btn-container" style="margin-top:2vh;"></div>
    </div>
  </div>
</div>

<img id="gameover-bg" src="assets/backgrounds/gameOver_bg.png" alt="" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);object-fit:cover;z-index:-1;display:none;"/>
<img id="go-title" src="assets/text/text_gameOver.png" alt="Game Over Title" style="position:fixed;left:50%;top:75px;transform:translateX(-50%);height:auto;width:auto;z-index:9;display:none;"/>
<img id="menu-logo" src="assets/text/textLogo.png" alt="" style="position:fixed;left:calc(5vw - 125px);top:5px;width:45vw;height:auto;z-index:2;display:none;pointer-events:none;"/>
<img id="btn-worldmap" src="assets/buttons/button_worldMap.png" alt="World Map"
     style="position:fixed;left:50%;top:400px;transform:translateX(-50%);
            height:105px;width:auto;z-index:3;display:none;cursor:pointer;"/>
<img id="btn-shop" src="assets/buttons/button_shop.png" alt="Shop"
     style="position:fixed;left:calc(50% - 120px);top:525px;transform:translateX(-50%);
            height:55px;width:auto;z-index:3;display:none;cursor:pointer;"/>
<img id="btn-leaderboard" src="assets/buttons/button_leaderboard.png" alt="Leaderboard"
     style="position:fixed;left:50%;top:525px;transform:translateX(-50%);
            height:55px;width:auto;z-index:3;display:none;cursor:pointer;"/>
<img id="btn-profile" src="assets/buttons/button_profile.png" alt="Profile"
     style="position:fixed;left:calc(50% + 120px);top:525px;transform:translateX(-50%);
            height:55px;width:auto;z-index:3;display:none;cursor:pointer;"/>
<img id="btn-logout" src="assets/buttons/button_logout.png" alt="Logout"
     style="position:fixed;left:calc(50% - 70px);bottom:30px;transform:translateX(-50%);
            height:45px;width:auto;z-index:10;display:none;cursor:pointer;"/>
<img id="btn-continue" src="assets/buttons/button_continue.png" alt="Continue"
     style="position:fixed;left:50%;top:430px;transform:translateX(-50%);
            width:220px;height:auto;z-index:10;display:none;cursor:pointer;"/>
<img id="btn-next" src="assets/buttons/button_nextLevel.png" alt="Next Level"
     style="position:fixed;left:50%;top:500px;transform:translateX(-50%);
            width:auto;height:auto;z-index:10;display:none;cursor:pointer;"/>
<img id="btn-menu" src="assets/buttons/button_menu.png" alt="Menu"
     style="position:fixed;right:16px;bottom:16px;transform-origin: bottom right;transform: scale(0.5);
            width:auto;height:auto;z-index:10;display:none;cursor:pointer;"/>
<img id="btn-submit" src="assets/buttons/button_submitScore.png" alt="Submit Score"
     style="position:fixed;left:50%;top:335px;transform:translateX(-50%);
            width:154px;height:auto;z-index:10;display:none;cursor:pointer;"/>
<img id="btn-try" src="assets/buttons/button_tryAgain.png" alt="Try Again"
     style="position:fixed;left:50%;top:455px;transform:translateX(-50%);
            width:260px;height:auto;z-index:10;display:none;cursor:pointer;"/>
<img id="btn-worldmap-go" src="assets/buttons/button_worldMap.png" alt="World Map"
     style="position:fixed;left:50%;top:505px;transform:translateX(-50%);
            width:260px;height:auto;z-index:10;display:none;cursor:pointer;"/>
<img id="btn-quit" src="assets/buttons/button_quit.png" alt="Quit"
     style="position:fixed;left:calc(50% + 70px);bottom:30px;transform:translateX(-50%);
            height:45px;width:auto;z-index:10;display:none;cursor:pointer;"/>
<!-- Game Over Total Points (DOM element for debug outline support) -->
<div id="go-total-points" style="position:fixed;left:50%;transform:translateX(-50%);
     color:#FFD700;font-family:Arial,sans-serif;font-size:20px;text-align:center;
     text-shadow:2px 2px 4px #000;z-index:10;display:none;"></div>
<!-- Game Over Button Container -->
<div id="go-btn-container" style="position:fixed;left:50%;transform:translateX(-50%);
     width:180px;display:none;flex-direction:column;align-items:center;gap:8px;z-index:10;">
</div>
<!-- Consequence Frame -->
<div id="consequence-container" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);display:none;z-index:100;">
  <div id="consequence-frame" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);height:calc(var(--vh, 1vh) * 60);width:calc(var(--vh, 1vh) * 60 * 1.5);">
    <!-- Frame image layer (aspect ratio 1536:1024 = 1.5:1) -->
    <img src="assets/frames/frame_consequence.png" style="position:absolute;inset:0;width:100%;height:100%;object-fit:fill;pointer-events:none;"/>
    <!-- Safe area for content (insets: top 18%, right 8%, bottom 10%, left 8%) -->
    <div id="consequence-safe-area" style="position:absolute;top:18%;left:8%;right:8%;bottom:10%;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;">
      <div id="consequence-text" style="color:#fff;font-family:Arial,sans-serif;font-size:clamp(16px, 3vh, 24px);text-align:center;text-shadow:2px 2px 4px #000;line-height:1.4;margin-bottom:2vh;"></div>
      <div id="consequence-stats" style="color:#fff;font-family:Arial,sans-serif;font-size:clamp(14px, 2.5vh, 20px);text-shadow:2px 2px 4px #000;margin-bottom:2vh;"></div>
      <div id="consequence-btn-container" style="display:flex;justify-content:center;width:100%;"></div>
    </div>
  </div>
</div>

<!-- Zone Complete Popup -->
<div id="zone-complete-container" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);display:none;z-index:100;background:rgba(0,0,0,0.7);">
  <div id="zone-complete-frame" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);height:calc(var(--vh, 1vh) * 60);width:calc(var(--vh, 1vh) * 60 * 1.5);opacity:0;">
    <!-- Frame image layer (aspect ratio 1536:1024 = 1.5:1) -->
    <img src="assets/frames/frame_consequence.png" style="position:absolute;inset:0;width:100%;height:100%;object-fit:fill;pointer-events:none;"/>
    <!-- Safe area for content -->
    <div id="zone-complete-safe-area" style="position:absolute;top:18%;left:8%;right:8%;bottom:10%;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;">
      <div id="zone-complete-title" style="color:#FFD700;font-family:Georgia,serif;font-size:clamp(28px, 5vh, 48px);text-align:center;text-shadow:2px 2px 4px #000;margin-bottom:1vh;">Zone Complete!</div>
      <div id="zone-complete-subtitle" style="color:#F5DEB3;font-family:Arial,sans-serif;font-size:clamp(16px, 3vh, 24px);text-align:center;text-shadow:2px 2px 4px #000;margin-bottom:3vh;"></div>
      <div id="zone-complete-btn-container" style="display:flex;justify-content:center;width:100%;"></div>
    </div>
  </div>
</div>

<!-- New Scene Backgrounds -->
<img id="login-bg" src="assets/backgrounds/login_bg.png" alt="" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);object-fit:cover;z-index:99;display:none;"/>
<img id="worldmap-bg" src="assets/backgrounds/worldmap_bg.png" alt="" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);object-fit:cover;z-index:99;display:none;"/>
<img id="shop-bg" src="assets/backgrounds/shop_bg.png" alt="" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);object-fit:cover;z-index:99;display:none;"/>
<img id="profile-bg" src="assets/backgrounds/profile_bg.png" alt="" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);object-fit:cover;z-index:99;display:none;"/>

<!-- Points Icon -->
<img id="points-icon" src="assets/icons/icon_currency.png" alt="Points" title="Points" style="width:28px;height:28px;vertical-align:middle;display:none;"/>

<!-- Game HUD Elements -->
<div id="game-hud" style="position:fixed;top:0;left:0;right:0;display:none;z-index:50;padding:20px;">
  <div id="hud-left" style="position:absolute;left:20px;top:20px;">
    <div id="hud-health" style="color:#fff;font-family:Arial,sans-serif;font-size:20px;text-shadow:2px 2px 4px #000;margin-bottom:5px;">Health: 10</div>
    <div id="hud-points" style="color:#fff;font-family:Arial,sans-serif;font-size:20px;text-shadow:2px 2px 4px #000;">Points: 0</div>
  </div>
  <div id="hud-right" style="position:absolute;right:20px;top:20px;text-align:right;">
    <div id="hud-level" style="color:#fff;font-family:Arial,sans-serif;font-size:18px;text-shadow:2px 2px 4px #000;margin-bottom:3px;">Level: 1</div>
    <div id="hud-stage" style="color:#fff;font-family:Arial,sans-serif;font-size:18px;text-shadow:2px 2px 4px #000;margin-bottom:3px;">Stage: 1</div>
    <div id="hud-zone" style="color:#fff;font-family:Arial,sans-serif;font-size:16px;text-shadow:2px 2px 4px #000;">Zone Name</div>
  </div>
</div>

<!-- Question and Choice Frames for Gameplay -->
<div id="question-frame" style="position:fixed;left:50%;top:180px;transform:translateX(-50%);width:750px;height:225px;display:none;z-index:50;">
  <!-- Frame background layer -->
  <div style="position:absolute;inset:0;background:url('assets/frames/frame_question.png') center/100% 100% no-repeat;"></div>
  <!-- Safe area for text content (insets: top 18%, right 8%, bottom 18%, left 8%) -->
  <div id="question-safe-area" style="position:absolute;top:18%;left:8%;right:8%;bottom:18%;display:flex;align-items:center;justify-content:center;">
    <div id="question-text" style="color:#F5DEB3;font-family:Georgia,serif;font-size:24px;text-align:center;text-shadow:2px 2px 4px #000;line-height:1.4;"></div>
  </div>
</div>
<div id="choices-container" style="position:fixed;left:50%;top:430px;transform:translateX(-50%);display:none;z-index:50;width:900px;">
  <div style="display:flex;justify-content:center;gap:30px;">
    <div id="choice-a-frame" style="position:relative;width:400px;height:160px;cursor:pointer;">
      <!-- Frame background layer -->
      <div style="position:absolute;inset:0;background:url('assets/frames/frame_choice.png') center/100% 100% no-repeat;"></div>
      <!-- Safe area for text content (insets: top 18%, right 9%, bottom 18%, left 9%) -->
      <div id="choice-a-safe-area" style="position:absolute;top:18%;left:9%;right:9%;bottom:18%;display:flex;align-items:center;justify-content:center;">
        <div id="choice-a-text" style="color:#F5DEB3;font-family:Georgia,serif;font-size:16px;text-align:center;text-shadow:1px 1px 3px #000;line-height:1.3;"></div>
      </div>
    </div>
    <div id="choice-b-frame" style="position:relative;width:400px;height:160px;cursor:pointer;">
      <!-- Frame background layer -->
      <div style="position:absolute;inset:0;background:url('assets/frames/frame_choice.png') center/100% 100% no-repeat;"></div>
      <!-- Safe area for text content (insets: top 18%, right 9%, bottom 18%, left 9%) -->
      <div id="choice-b-safe-area" style="position:absolute;top:18%;left:9%;right:9%;bottom:18%;display:flex;align-items:center;justify-content:center;">
        <div id="choice-b-text" style="color:#F5DEB3;font-family:Georgia,serif;font-size:16px;text-align:center;text-shadow:1px 1px 3px #000;line-height:1.3;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Login Scene Elements -->
<div id="login-container" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);background:transparent;display:none;z-index:100;">
  <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center;">
    <h1 style="color:#e94560;font-family:Arial;font-size:48px;margin-bottom:10px;text-shadow:2px 2px 4px #000;">TROLLEY PROBLEM</h1>
    <p style="color:#fff;font-family:Arial;font-size:18px;margin-bottom:40px;">Make your choices. Face the consequences.</p>
    <div style="background:rgba(255,255,255,0.1);padding:30px;border-radius:10px;margin-bottom:20px;">
      <input id="login-username" type="text" placeholder="Enter your username" maxlength="16"
             style="width:250px;padding:12px;font-size:18px;border:none;border-radius:5px;margin-bottom:15px;text-align:center;"/>
      <br/>
      <button id="btn-login" style="width:200px;padding:12px;font-size:18px;background:#e94560;color:#fff;border:none;border-radius:5px;cursor:pointer;margin:5px;">
        Login / Create
      </button>
      <br/>
      <button id="btn-guest" style="width:200px;padding:12px;font-size:16px;background:#444;color:#fff;border:none;border-radius:5px;cursor:pointer;margin:5px;">
        Continue as Guest
      </button>
    </div>
  </div>
</div>

<!-- World Map Scene Elements -->
<div id="worldmap-container" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);background:transparent;display:none;z-index:100;">
  <h1 id="worldmap-title" style="position:absolute;left:30px;top:30px;color:#F5DEB3;font-family:Georgia,serif;font-size:32px;text-shadow:2px 2px 4px #000;">SELECT ZONE</h1>

  <!-- Zone Markers (left side of map) -->
  <div id="zone-markers" style="position:absolute;left:50px;top:150px;width:400px;">
    <div class="zone-marker" data-zone="1" style="position:absolute;left:100px;top:200px;width:80px;height:80px;background:rgba(0,0,0,0.6);border:3px solid #B8860B;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;">
      <span style="font-size:36px;">üöÇ</span>
    </div>
    <div class="zone-marker" data-zone="2" style="position:absolute;left:220px;top:100px;width:80px;height:80px;background:rgba(0,0,0,0.6);border:3px solid #B8860B;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;">
      <span style="font-size:36px;">üè≠</span>
    </div>
    <div class="zone-marker" data-zone="3" style="position:absolute;left:340px;top:30px;width:80px;height:80px;background:rgba(0,0,0,0.6);border:3px solid #B8860B;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;">
      <span style="font-size:36px;">üåÜ</span>
    </div>
  </div>

  <!-- Zone Detail Panel (right side) -->
  <div id="zone-detail-frame" style="position:absolute;right:30px;top:50%;transform:translateY(-50%);width:min(1000px, 50vw);height:min(1400px, calc(var(--vh, 1vh) * 92));display:none;">
    <!-- Dark background layer (75% of frame size) -->
    <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:75%;height:75%;background:rgba(15,15,25,0.95);border-radius:12px;"></div>
    <!-- Frame image layer (102% horizontal stretch) -->
    <img src="assets/frames/frame_zoneCard.png" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:102%;height:100%;object-fit:fill;pointer-events:none;"/>
    <!-- Safe area for content (insets: top 8%, right 34%, bottom 8%, left 34%) -->
    <div id="zone-detail-safe-area" style="position:absolute;top:8%;left:34%;right:34%;bottom:8%;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;">
      <h2 id="zone-detail-name" style="color:#FFD700;font-family:Georgia,serif;font-size:24px;margin:0 0 8px 0;text-shadow:1px 1px 2px #000;text-align:center;"></h2>
      <p id="zone-detail-desc" style="color:#F5DEB3;font-family:Arial;font-size:13px;margin:0 0 12px 0;line-height:1.3;text-align:center;"></p>

      <div style="margin-bottom:12px;text-align:left;">
        <span style="color:#aaa;font-family:Arial;font-size:11px;">DIFFICULTY</span>
        <div id="zone-detail-difficulty" style="color:#fff;font-family:Arial;font-size:14px;margin-top:3px;"></div>
      </div>

      <div style="margin-bottom:12px;text-align:left;">
        <span style="color:#aaa;font-family:Arial;font-size:11px;">CHOICES PER LEVEL</span>
        <div id="zone-detail-choices" style="color:#fff;font-family:Arial;font-size:14px;margin-top:3px;"></div>
      </div>

      <div style="margin-bottom:15px;text-align:left;">
        <span style="color:#aaa;font-family:Arial;font-size:11px;">PROGRESS</span>
        <div style="background:rgba(255,255,255,0.2);border-radius:5px;height:16px;overflow:hidden;margin-top:3px;">
          <div id="zone-detail-progress-bar" style="height:100%;background:#4CAF50;transition:width 0.3s;"></div>
        </div>
        <div id="zone-detail-progress-text" style="color:#fff;font-family:Arial;font-size:11px;margin-top:3px;"></div>
      </div>

      <div id="zone-difficulty-selector" style="margin-bottom:15px;text-align:center;display:none;">
        <span style="color:#aaa;font-family:Arial;font-size:11px;display:block;margin-bottom:6px;">SELECT DIFFICULTY</span>
        <div style="display:flex;justify-content:center;align-items:center;">
          <button class="difficulty-btn" data-difficulty="1">1</button>
          <button class="difficulty-btn" data-difficulty="2">2</button>
          <button class="difficulty-btn" data-difficulty="3">3</button>
        </div>
        <div id="zone-difficulty-multiplier" style="color:#FFD700;font-family:Arial;font-size:12px;margin-top:6px;">1.0x Multiplier</div>
      </div>

      <div id="zone-detail-locked" style="color:#e94560;font-family:Arial;font-size:13px;margin-bottom:12px;display:none;text-align:center;">
        üîí Complete previous zone to unlock
      </div>

      <img id="btn-zone-start" src="assets/buttons/button_startGame.png" alt="Start" style="width:180px;height:auto;cursor:pointer;display:block;margin:10px auto 0 auto;"/>
    </div>
  </div>

  <!-- Back Button -->
  <button id="btn-worldmap-back" style="position:absolute;left:20px;bottom:20px;padding:12px 24px;font-size:16px;background:#e94560;color:#fff;border:none;border-radius:5px;cursor:pointer;">
    ‚Üê Back to Menu
  </button>
</div>

<!-- Shop Scene Elements -->
<div id="shop-container" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);background:transparent;display:none;z-index:100;">
  <h1 style="position:absolute;left:50%;top:20px;transform:translateX(-50%);color:#ffd700;font-family:Arial;font-size:36px;text-shadow:2px 2px 4px #000;">SHOP</h1>
  <div id="shop-points" style="position:absolute;right:30px;top:25px;color:#ffd700;font-family:Arial;font-size:24px;">üí∞ 0 Points</div>
  <div id="shop-tabs" style="position:absolute;left:50%;top:100px;transform:translateX(-50%);display:flex;gap:0;">
    <button id="tab-cosmetics" style="padding:12px 35px;font-size:16px;background:#ffd700;color:#000;border:none;border-radius:8px 8px 0 0;cursor:pointer;margin-bottom:-1px;">Cosmetics</button>
    <button id="tab-consumables" style="padding:12px 35px;font-size:16px;background:#555;color:#fff;border:none;border-radius:8px 8px 0 0;cursor:pointer;margin-bottom:-1px;">Consumables</button>
  </div>
  <div id="shop-items" style="position:absolute;left:50%;top:148px;transform:translateX(-50%);width:90%;max-width:720px;height:auto;max-height:calc(100% - 220px);background:rgba(0,0,0,0.7);border-radius:0 10px 10px 10px;padding:15px;overflow:hidden;border-top:3px solid #ffd700;display:flex;flex-direction:column;">
    <div id="shop-items-grid" style="flex:1;display:flex;flex-wrap:wrap;justify-content:center;align-content:flex-start;"></div>
    <div id="shop-pagination" style="display:flex;justify-content:center;align-items:center;gap:20px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.2);margin-top:8px;flex-shrink:0;">
      <button id="shop-prev" style="padding:6px 14px;font-size:16px;background:#ffd700;color:#000;border:none;border-radius:5px;cursor:pointer;">‚Üê</button>
      <span id="shop-page-info" style="color:#fff;font-family:Arial;font-size:13px;">Page 1 / 1</span>
      <button id="shop-next" style="padding:6px 14px;font-size:16px;background:#ffd700;color:#000;border:none;border-radius:5px;cursor:pointer;">‚Üí</button>
    </div>
  </div>
  <button id="btn-shop-back" style="position:absolute;left:20px;bottom:20px;padding:12px 24px;font-size:16px;background:#ffd700;color:#000;border:none;border-radius:5px;cursor:pointer;">
    ‚Üê Back to Menu
  </button>
</div>

<!-- Profile Scene Elements -->
<div id="profile-container" style="position:fixed;left:0;top:0;width:100vw;height:calc(var(--vh, 1vh) * 100);background:transparent;display:none;z-index:100;">
  <h1 style="position:absolute;left:50%;top:20px;transform:translateX(-50%);color:#fff;font-family:Arial;font-size:36px;text-shadow:2px 2px 4px #000;">PROFILE</h1>
  <div id="profile-content" style="position:absolute;left:50%;top:80px;transform:translateX(-50%);width:80%;max-width:600px;background:rgba(0,0,0,0.7);border-radius:10px;padding:30px;"></div>
  <div id="achievements-content" style="position:absolute;left:50%;top:480px;transform:translateX(-50%);width:80%;max-width:600px;background:rgba(0,0,0,0.7);border-radius:10px;padding:20px;"></div>
  <button id="btn-profile-back" style="position:absolute;left:20px;bottom:20px;padding:12px 24px;font-size:16px;background:#fff;color:#0d7377;border:none;border-radius:5px;cursor:pointer;">
    ‚Üê Back to Menu
  </button>
</div>

<!-- Item Bar for Level Scene -->
<div id="item-bar" style="position:fixed;left:50%;bottom:80px;transform:translateX(-50%);display:none;z-index:50;background:rgba(0,0,0,0.7);padding:10px 20px;border-radius:10px;">
  <span style="color:#fff;font-family:Arial;margin-right:15px;">Items:</span>
  <button id="item-hp-small" style="padding:8px 12px;margin:0 5px;background:#4CAF50;color:#fff;border:none;border-radius:5px;cursor:pointer;display:none;">+3 HP (0)</button>
  <button id="item-hp-large" style="padding:8px 12px;margin:0 5px;background:#2196F3;color:#fff;border:none;border-radius:5px;cursor:pointer;display:none;">+7 HP (0)</button>
  <button id="item-point-boost" style="padding:8px 12px;margin:0 5px;background:#FF9800;color:#fff;border:none;border-radius:5px;cursor:pointer;display:none;">2x Points (0)</button>
  <span id="items-used" style="color:#aaa;font-family:Arial;margin-left:15px;font-size:14px;">(0/3 used)</span>
</div>

<script>
// Set actual viewport height (accounts for taskbar/browser UI)
function setViewportHeight() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setViewportHeight();
window.addEventListener('resize', setViewportHeight);

// Debug button - hold to show outlines
(function() {
  const debugBtn = document.getElementById('debug-btn');
  if (debugBtn) {
    const enableDebug = () => document.body.classList.add('debug-active');
    const disableDebug = () => document.body.classList.remove('debug-active');

    // Mouse events
    debugBtn.addEventListener('mousedown', enableDebug);
    debugBtn.addEventListener('mouseup', disableDebug);
    debugBtn.addEventListener('mouseleave', disableDebug);

    // Touch events for mobile
    debugBtn.addEventListener('touchstart', (e) => { e.preventDefault(); enableDebug(); });
    debugBtn.addEventListener('touchend', disableDebug);
    debugBtn.addEventListener('touchcancel', disableDebug);
  }
})();

// Leaderboard storage helpers
function getLeaderboard() {
  const data = localStorage.getItem('trolley_leaderboard');
  return data ? JSON.parse(data) : [];
}
function saveLeaderboard(list) {
  localStorage.setItem('trolley_leaderboard', JSON.stringify(list));
}

// =====================================================
// USER ACCOUNT SYSTEM
// =====================================================
function generateUserId() {
  return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function createUser(username, isGuest = false) {
  const user = {
    userId: generateUserId(),
    username: username,
    isGuest: isGuest,
    createdAt: Date.now(),
    lastLogin: Date.now(),
    dataVersion: 1,
    progress: {
      currentZone: 1,
      completedLevels: [], // [{zone: 1, level: 1, score: 100, perfect: false}]
      highScores: {}, // {"1-1": 100, "1-2": 150}
      zoneCompletions: {} // {1: 1, 2: 0, 3: 0} - highest difficulty completed per zone
    },
    stats: {
      totalGames: 0,
      totalPoints: 0,
      totalDeaths: 0,
      choicesMade: 0,
      perfectLevels: 0,
      zonesCompleted: 0
    },
    inventory: {
      currency: 0,
      cosmetics: ['trolley_default'],
      consumables: {
        hp_small: 0,
        hp_large: 0,
        point_boost: 0
      }
    },
    equipped: {
      trolleyAppearance: 'trolley_default'
    },
    achievements: []
  };
  saveUser(user);
  return user;
}

function getUser() {
  const data = localStorage.getItem('trolley_user');
  if (!data) return null;
  try {
    return JSON.parse(data);
  } catch(e) {
    return null;
  }
}

function saveUser(user) {
  user.lastLogin = Date.now();
  localStorage.setItem('trolley_user', JSON.stringify(user));
}

function clearUser() {
  localStorage.removeItem('trolley_user');
}

// =====================================================
// ZONE CONFIGURATION
// =====================================================
const ZoneConfig = [
  {
    id: 1,
    name: 'Starter Rails',
    description: 'Begin your journey on quiet suburban tracks.',
    choicesPerLevel: 3,
    levelsRequired: 5,
    difficultyMod: 1.0,
    unlockRequirement: 0, // always unlocked
    currencyBonus: 1.0,
    color: '#4CAF50',
    bgSuffix: 'level_01_background.png'
  },
  {
    id: 2,
    name: 'Industrial District',
    description: 'Navigate through the factory zone.',
    choicesPerLevel: 4,
    levelsRequired: 5,
    difficultyMod: 1.3,
    unlockRequirement: 5, // need 5 levels from zone 1
    currencyBonus: 1.05,
    color: '#FF9800',
    bgSuffix: 'level_01_background.png' // reuse until new assets
  },
  {
    id: 3,
    name: 'City Center',
    description: 'High stakes in the urban core.',
    choicesPerLevel: 5,
    levelsRequired: 5,
    difficultyMod: 1.6,
    unlockRequirement: 5, // need 5 levels from zone 2
    currencyBonus: 1.1,
    color: '#E91E63',
    bgSuffix: 'level_01_background.png' // reuse until new assets
  }
];

// Zone-themed prompts for variety
const ZonePrompts = {
  1: [ // Starter Rails
    {prompt:'Help child cross or save luggage?',opts:[{text:'Help child',pts:8,hp:0},{text:'Save luggage',pts:4,hp:0}]},
    {prompt:'Find water or conserve energy?',opts:[{text:'Find water',pts:3,hp:3},{text:'Conserve energy',pts:5,hp:0}]},
    {prompt:'Use first aid or press on?',opts:[{text:'Use first aid',pts:2,hp:4},{text:'Press on',pts:8,hp:-1}]},
    {prompt:'Steer on grass or hit barrier?',opts:[{text:'Grass',pts:6,hp:-2},{text:'Barrier',pts:12,hp:-5}]},
    {prompt:'Warn engineer or do nothing?',opts:[{text:'Warn',pts:10,hp:-1},{text:'Nothing',pts:0,hp:0}]},
    {prompt:'Take shortcut or stay on track?',opts:[{text:'Shortcut',pts:7,hp:-2},{text:'Stay safe',pts:3,hp:1}]},
    {prompt:'Help stranded motorist?',opts:[{text:'Help them',pts:6,hp:-1},{text:'Keep moving',pts:2,hp:0}]}
  ],
  2: [ // Industrial District
    {prompt:'Divert through factory or main line?',opts:[{text:'Factory',pts:12,hp:-3},{text:'Main line',pts:5,hp:-1}]},
    {prompt:'Warn workers or maintain speed?',opts:[{text:'Warn workers',pts:8,hp:0},{text:'Maintain speed',pts:15,hp:-4}]},
    {prompt:'Use emergency brake?',opts:[{text:'Pull brake',pts:4,hp:2},{text:'Coast through',pts:10,hp:-2}]},
    {prompt:'Take cargo shortcut?',opts:[{text:'Risk it',pts:14,hp:-4},{text:'Standard route',pts:6,hp:0}]},
    {prompt:'Help trapped worker?',opts:[{text:'Rescue',pts:10,hp:-2},{text:'Call for backup',pts:5,hp:0}]},
    {prompt:'Navigate steam vents?',opts:[{text:'Push through',pts:9,hp:-3},{text:'Wait',pts:3,hp:1}]},
    {prompt:'Cross unstable bridge?',opts:[{text:'Cross fast',pts:13,hp:-4},{text:'Find alternate',pts:5,hp:-1}]}
  ],
  3: [ // City Center
    {prompt:'Rush hour crossing?',opts:[{text:'Force through',pts:18,hp:-5},{text:'Wait for clear',pts:6,hp:0}]},
    {prompt:'Detour through park?',opts:[{text:'Park route',pts:12,hp:-2},{text:'Street route',pts:8,hp:-3}]},
    {prompt:'Emergency vehicle approaching!',opts:[{text:'Yield',pts:5,hp:0},{text:'Race ahead',pts:16,hp:-4}]},
    {prompt:'Construction zone ahead!',opts:[{text:'Plow through',pts:20,hp:-6},{text:'Detour',pts:8,hp:-1}]},
    {prompt:'School zone - children present!',opts:[{text:'Slow down',pts:4,hp:2},{text:'Maintain speed',pts:12,hp:-3}]},
    {prompt:'Traffic signal malfunction!',opts:[{text:'Go anyway',pts:15,hp:-4},{text:'Wait',pts:3,hp:1}]},
    {prompt:'Pedestrian on tracks!',opts:[{text:'Emergency stop',pts:6,hp:3},{text:'Swerve',pts:14,hp:-5}]}
  ]
};

// =====================================================
// SHOP ITEMS CONFIGURATION
// =====================================================
const ShopItems = {
  cosmetics: [
    { id: 'trolley_default', name: 'Standard Trolley', price: 0, owned: true, color: '#888', preview: 'assets/trolley_skins/trolley_preview_standard.png' },
    { id: 'trolley_gold', name: 'Golden Trolley', price: 500, owned: false, color: '#FFD700', preview: 'assets/trolley_skins/trolley_preview_gold.png' },
    { id: 'trolley_fire', name: 'Flame Trolley', price: 750, owned: false, color: '#FF4500', preview: 'assets/trolley_skins/trolley_preview_fire.png' },
    { id: 'trolley_ice', name: 'Frost Trolley', price: 750, owned: false, color: '#00CED1', preview: 'assets/trolley_skins/trolley_preview_ice.png' },
    { id: 'trolley_neon', name: 'Neon Trolley', price: 1000, owned: false, color: '#FF00FF', preview: 'assets/trolley_skins/trolley_preview_neon.png' },
    { id: 'trolley_shadow', name: 'Shadow Trolley', price: 1500, owned: false, color: '#2F2F2F', preview: 'assets/trolley_skins/trolley_preview_shadow.png' }
  ],
  consumables: [
    { id: 'hp_small', name: 'Small Health Pack', price: 100, effect: '+3 HP', value: 3 },
    { id: 'hp_large', name: 'Large Health Pack', price: 250, effect: '+7 HP', value: 7 },
    { id: 'point_boost', name: 'Point Booster', price: 200, effect: '2x Points (1 level)', value: 2 }
  ]
};

// =====================================================
// ACHIEVEMENT DEFINITIONS
// =====================================================
const AchievementDefs = [
  { id: 'first_game', name: 'First Steps', desc: 'Complete your first game', icon: 'üéÆ' },
  { id: 'zone1_complete', name: 'Starter Champion', desc: 'Complete Zone 1', icon: 'üèÜ' },
  { id: 'zone2_complete', name: 'Industrial Expert', desc: 'Complete Zone 2', icon: 'üè≠' },
  { id: 'zone3_complete', name: 'City Master', desc: 'Complete Zone 3', icon: 'üåÜ' },
  { id: 'perfect_level', name: 'Perfectionist', desc: 'Complete a level without taking damage', icon: '‚≠ê' },
  { id: 'high_roller', name: 'High Roller', desc: 'Earn 1000+ points', icon: 'üí∞' },
  { id: 'collector', name: 'Collector', desc: 'Own 3 trolley cosmetics', icon: 'üé®' },
  { id: 'survivor', name: 'Survivor', desc: 'Survive with 1 HP', icon: '‚ù§Ô∏è' }
];

function checkAchievements(user) {
  const earned = [];
  // First game
  if (user.stats.totalGames >= 1 && !user.achievements.includes('first_game')) {
    earned.push('first_game');
  }
  // Zone completions
  const zone1Complete = user.progress.completedLevels.filter(l => l.zone === 1).length >= 5;
  const zone2Complete = user.progress.completedLevels.filter(l => l.zone === 2).length >= 5;
  const zone3Complete = user.progress.completedLevels.filter(l => l.zone === 3).length >= 5;
  if (zone1Complete && !user.achievements.includes('zone1_complete')) earned.push('zone1_complete');
  if (zone2Complete && !user.achievements.includes('zone2_complete')) earned.push('zone2_complete');
  if (zone3Complete && !user.achievements.includes('zone3_complete')) earned.push('zone3_complete');
  // Perfect level
  if (user.stats.perfectLevels >= 1 && !user.achievements.includes('perfect_level')) {
    earned.push('perfect_level');
  }
  // High roller
  if (user.inventory.currency >= 1000 && !user.achievements.includes('high_roller')) {
    earned.push('high_roller');
  }
  // Collector
  if (user.inventory.cosmetics.length >= 3 && !user.achievements.includes('collector')) {
    earned.push('collector');
  }
  return earned;
}

// Helper to calculate points earned
function calculatePointsEarned(score, zoneId, isPerfect) {
  const zone = ZoneConfig.find(z => z.id === zoneId) || ZoneConfig[0];
  let base = score; // 1:1 score to points
  base = Math.floor(base * zone.currencyBonus); // Zone bonus
  if (isPerfect) base = Math.floor(base * 1.5); // Perfect bonus
  return Math.max(base, 1); // Minimum 1 point
}

// Helper to hide all scene containers and backgrounds
function hideAllContainers() {
  const containers = ['login-container', 'worldmap-container', 'shop-container', 'profile-container', 'zone-complete-container'];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  // Hide new scene backgrounds
  const backgrounds = ['login-bg', 'worldmap-bg', 'shop-bg', 'profile-bg'];
  backgrounds.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  const itemBar = document.getElementById('item-bar');
  if (itemBar) itemBar.style.display = 'none';
  // Hide menu points and welcome displays
  const menuPoints = document.getElementById('menu-points-display');
  if (menuPoints) menuPoints.style.display = 'none';
  const menuWelcome = document.getElementById('menu-welcome-display');
  if (menuWelcome) menuWelcome.style.display = 'none';
  // Hide question and choice frames
  const questionFrame = document.getElementById('question-frame');
  if (questionFrame) questionFrame.style.display = 'none';
  const choicesContainer = document.getElementById('choices-container');
  if (choicesContainer) choicesContainer.style.display = 'none';
  // Hide game HUD
  const gameHud = document.getElementById('game-hud');
  if (gameHud) gameHud.style.display = 'none';
  // Hide consequence container
  const consContainer = document.getElementById('consequence-container');
  if (consContainer) consContainer.style.display = 'none';
  // Hide game over elements - move buttons back to body before clearing container
  const goBtnContainer = document.getElementById('go-btn-container');
  if (goBtnContainer) {
    // Move buttons back to body to preserve them
    const buttonsToRestore = ['btn-worldmap-go', 'btn-try', 'btn-submit', 'btn-menu'];
    buttonsToRestore.forEach(id => {
      const btn = document.getElementById(id);
      if (btn && btn.parentElement === goBtnContainer) {
        btn.style.display = 'none';
        btn.style.position = 'fixed';
        btn.onclick = null;
        document.body.appendChild(btn);
      }
    });
    goBtnContainer.style.display = 'none';
  }
  const goTotalPoints = document.getElementById('go-total-points');
  if (goTotalPoints) goTotalPoints.style.display = 'none';
}

// =====================================================
// LOGIN SCENE
// =====================================================
class LoginScene extends Phaser.Scene {
  constructor() { super('LoginScene'); }

  create() {
    // Hide all other DOM elements
    hideAllContainers();
    const domBg = document.getElementById('menu-bg'); if (domBg) domBg.style.display = 'none';
    const domLogo = document.getElementById('menu-logo'); if (domLogo) domLogo.style.display = 'none';
    const levelBg = document.getElementById('level-bg'); if (levelBg) levelBg.style.display = 'none';
    const leaderboardBg = document.getElementById('leaderboard-container'); if (leaderboardBg) leaderboardBg.style.display = 'none';
    const gameOverBg = document.getElementById('gameover-bg'); if (gameOverBg) gameOverBg.style.display = 'none';
    const consBg = document.getElementById('consequence-container'); if (consBg) consBg.style.display = 'none';
    const goTitle = document.getElementById('go-title'); if (goTitle) goTitle.style.display = 'none';

    // Hide all buttons
    const buttons = ['btn-worldmap', 'btn-leaderboard', 'btn-shop', 'btn-profile', 'btn-logout', 'btn-continue', 'btn-next', 'btn-menu', 'btn-submit', 'btn-try', 'btn-worldmap-go', 'btn-quit'];
    buttons.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) { btn.style.display = 'none'; btn.onclick = null; }
    });

    // Show login background and container
    const loginBg = document.getElementById('login-bg');
    if (loginBg) loginBg.style.display = 'block';
    const loginContainer = document.getElementById('login-container');
    if (loginContainer) loginContainer.style.display = 'block';

    // Setup login button
    const btnLogin = document.getElementById('btn-login');
    const usernameInput = document.getElementById('login-username');

    if (btnLogin) {
      btnLogin.onclick = () => {
        const username = usernameInput ? usernameInput.value.trim() : '';
        if (username.length < 1) {
          alert('Please enter a username (1-16 characters)');
          return;
        }
        // Check if user exists or create new
        let user = getUser();
        if (user && user.username === username) {
          // Existing user logging back in
          saveUser(user);
        } else {
          // Create new account
          user = createUser(username, false);
        }
        loginContainer.style.display = 'none';
        this.scene.start('MainMenuScene');
      };
    }

    // Setup guest button
    const btnGuest = document.getElementById('btn-guest');
    if (btnGuest) {
      btnGuest.onclick = () => {
        const guestId = 'Guest_' + Math.random().toString(36).substr(2, 6).toUpperCase();
        const user = createUser(guestId, true);
        loginContainer.style.display = 'none';
        this.scene.start('MainMenuScene');
      };
    }

    // Allow Enter key to submit
    if (usernameInput) {
      usernameInput.onkeydown = (e) => {
        if (e.key === 'Enter' && btnLogin) btnLogin.click();
      };
      usernameInput.value = '';
      usernameInput.focus();
    }
  }
}

class MainMenuScene extends Phaser.Scene {
  constructor() { super('MainMenuScene'); }
  create() {
    // Hide all containers first
    hideAllContainers();

    const domBg = document.getElementById('menu-bg'); if (domBg) domBg.style.display = 'block';
    const domLogo = document.getElementById('menu-logo'); if (domLogo) domLogo.style.display = 'block';
    // Hide level background when on main menu
    const levelBg = document.getElementById('level-bg'); if (levelBg) levelBg.style.display = 'none';
    const leaderboardBg = document.getElementById('leaderboard-container'); if (leaderboardBg) leaderboardBg.style.display = 'none';
    const gameOverBg = document.getElementById('gameover-bg'); if (gameOverBg) gameOverBg.style.display='none';
    document.body.style.backgroundColor = '';
    const consBgHideGO = document.getElementById('consequence-container'); if (consBgHideGO) consBgHideGO.style.display='none';
    const goTitleHideMM = document.getElementById('go-title'); if (goTitleHideMM) goTitleHideMM.style.display='none';

    // Ensure menu button is hidden on main menu (we only show it in Level/GameOver)
    const domMenuBtnMM = document.getElementById('btn-menu');
    if (domMenuBtnMM) { domMenuBtnMM.style.display='none'; domMenuBtnMM.onclick=null; }

    // Hide Game Over DOM buttons by default on menu
    const btnSubmitImg = document.getElementById('btn-submit'); if (btnSubmitImg) { btnSubmitImg.style.display='none'; btnSubmitImg.onclick=null; }
    const btnTryImg = document.getElementById('btn-try'); if (btnTryImg) { btnTryImg.style.display='none'; btnTryImg.onclick=null; }
    const btnWorldMapGoMM = document.getElementById('btn-worldmap-go'); if (btnWorldMapGoMM) { btnWorldMapGoMM.style.display='none'; btnWorldMapGoMM.onclick=null; }
    const btnNextMM = document.getElementById('btn-next'); if (btnNextMM) { btnNextMM.style.display='none'; btnNextMM.onclick=null; }
    const btnContinue = document.getElementById('btn-continue'); if (btnContinue) { btnContinue.style.display='none'; btnContinue.onclick=null; }

    // Get user data for display
    const user = getUser();

    // Display welcome message (left side, below title logo with buffer)
    if (user) {
      // Create or get DOM-based welcome display (well below logo bottom edge)
      let welcomeDisplay = document.getElementById('menu-welcome-display');
      if (!welcomeDisplay) {
        welcomeDisplay = document.createElement('div');
        welcomeDisplay.id = 'menu-welcome-display';
        document.body.appendChild(welcomeDisplay);
      }
      welcomeDisplay.style.cssText = 'position:fixed;left:calc(5vw + 80px);top:520px;color:#F5DEB3;font-family:Georgia,serif;font-size:22px;z-index:10;text-shadow:2px 2px 4px #000;';
      welcomeDisplay.textContent = `Welcome, ${user.username}!`;
      welcomeDisplay.style.display = 'block';

      // Create or get DOM-based points display with icon (below welcome)
      let pointsDisplay = document.getElementById('menu-points-display');
      if (!pointsDisplay) {
        pointsDisplay = document.createElement('div');
        pointsDisplay.id = 'menu-points-display';
        document.body.appendChild(pointsDisplay);
      }
      pointsDisplay.style.cssText = 'position:fixed;left:calc(5vw + 80px);top:555px;color:#FFD700;font-family:Arial;font-size:18px;z-index:10;text-shadow:2px 2px 3px #000;';
      pointsDisplay.innerHTML = `<img src="assets/icons/icon_currency.png" alt="Points" title="Points" style="width:22px;height:22px;vertical-align:middle;margin-right:6px;"/>${user.inventory.currency} Points`;
      pointsDisplay.style.display = 'block';
    }

    // Show World Map button (centered, larger - main action)
    const btnWorldMap = document.getElementById('btn-worldmap');
    if (btnWorldMap) {
      btnWorldMap.style.display = 'block';
      btnWorldMap.onclick = () => this.scene.start('WorldMapScene');
    }

    // Show Leaderboard, Shop, Profile buttons in a row (smaller, above World Map)
    const btnLeaderboard = document.getElementById('btn-leaderboard');
    if (btnLeaderboard) {
      btnLeaderboard.style.display = 'block';
      btnLeaderboard.onclick = () => this.scene.start('LeaderboardScene');
    }

    const btnShop = document.getElementById('btn-shop');
    if (btnShop) {
      btnShop.style.display = 'block';
      btnShop.onclick = () => this.scene.start('ShopScene');
    }

    const btnProfile = document.getElementById('btn-profile');
    if (btnProfile) {
      btnProfile.style.display = 'block';
      btnProfile.onclick = () => this.scene.start('ProfileScene');
    }

    // Show Logout button at bottom (left of Quit)
    const btnLogout = document.getElementById('btn-logout');
    if (btnLogout && user) {
      btnLogout.style.display = 'block';
      btnLogout.onclick = () => {
        clearUser();
        this.scene.start('LoginScene');
      };
    }

    // Show Quit button at bottom (right of Logout)
    const btnQuitMM = document.getElementById('btn-quit');
    if (btnQuitMM) {
      btnQuitMM.style.display = 'block';
      btnQuitMM.style.position = 'fixed';
      btnQuitMM.style.left = 'calc(50% + 70px)';
      btnQuitMM.style.bottom = '30px';
      btnQuitMM.style.top = '';
      btnQuitMM.style.transform = 'translateX(-50%)';
      btnQuitMM.style.zIndex = '10';
      btnQuitMM.onclick = () => window.close();
    }
  }
}

class LevelScene extends Phaser.Scene {
  constructor() { super('LevelScene'); }
  init() {
    if (this.registry.get('health')===undefined) this.registry.set('health',10);
    // Load points from user's persistent balance (don't reset)
    const user = getUser();
    const persistentPoints = user ? user.inventory.currency : 0;
    if (this.registry.get('points')===undefined) this.registry.set('points', persistentPoints);
    if (this.registry.get('level')===undefined) this.registry.set('level',1);
    if (this.registry.get('stage')===undefined) this.registry.set('stage',1);
    if (this.registry.get('zone')===undefined) this.registry.set('zone',1);

    // Track damage for perfect level detection
    this.damageTaken = 0;
    this.startingHealth = this.registry.get('health');

    // Track points earned this level for bonus calculation
    this.levelPointsEarned = 0;

    // Track items used this level (max 3)
    this.itemsUsedThisLevel = this.registry.get('itemsUsedThisLevel') || 0;

    // Point multiplier (from point boost consumable)
    this.pointMultiplier = this.registry.get('pointMultiplier') || 1;

    this.consequences = [
      'A stray dog trips over the tracks',
      'A sudden rainstorm reduces visibility',
      'You find an abandoned suitcase',
      'A loose plank causes a bump',
      'You spot an unexpected shortcut',
      'An old signal malfunctions',
      'You see something strange in the distance',
      'The track vibrates oddly',
      'A bird flies across your path'
    ];
  }
  create() {
    // Hide all containers
    hideAllContainers();

    // Hide menu DOM elements
    const domBg = document.getElementById('menu-bg'); if (domBg) domBg.style.display = 'none';
    const domLogo = document.getElementById('menu-logo'); if (domLogo) domLogo.style.display = 'none';
    const leaderboardBgLV = document.getElementById('leaderboard-container'); if (leaderboardBgLV) leaderboardBgLV.style.display='none';
    const gameOverBgLV = document.getElementById('gameover-bg'); if (gameOverBgLV) gameOverBgLV.style.display='none';
    document.body.style.backgroundColor = '';
    const levelBgElHide = document.getElementById('level-bg'); if (levelBgElHide) levelBgElHide.style.display = 'block';
    const btnWorldMapHide = document.getElementById('btn-worldmap'); if (btnWorldMapHide) btnWorldMapHide.style.display = 'none';
    const btnShopHide = document.getElementById('btn-shop'); if (btnShopHide) btnShopHide.style.display = 'none';
    const btnProfileHide = document.getElementById('btn-profile'); if (btnProfileHide) btnProfileHide.style.display = 'none';
    const btnLogoutHide = document.getElementById('btn-logout'); if (btnLogoutHide) btnLogoutHide.style.display = 'none';
    const btnLeaderboard = document.getElementById('btn-leaderboard'); if (btnLeaderboard) btnLeaderboard.style.display = 'none';
    const btnContinue = document.getElementById('btn-continue'); if (btnContinue) { btnContinue.style.display = 'none';
        btnContinue.onclick = null;
        const consBgHide = document.getElementById('consequence-container'); if (consBgHide) consBgHide.style.display='none';
        const consBg2 = document.getElementById('consequence-container'); if (consBg2) consBg2.style.display='none'; }
    const btnQuitReset = document.getElementById('btn-quit'); if (btnQuitReset) { btnQuitReset.style.display='none'; btnQuitReset.onclick=null; }
    const btnNextReset = document.getElementById('btn-next'); if (btnNextReset) { btnNextReset.style.display='none'; btnNextReset.onclick=null; }
    const domMenuBtn = document.getElementById('btn-menu'); if (domMenuBtn) { domMenuBtn.style.display='none'; domMenuBtn.onclick=null; }

    const btnQuitLBHide = document.getElementById('btn-quit'); if (btnQuitLBHide) { btnQuitLBHide.style.display='none'; btnQuitLBHide.onclick=null; }
    const btnSubmitImg2 = document.getElementById('btn-submit'); if (btnSubmitImg2) { btnSubmitImg2.style.display='none'; btnSubmitImg2.onclick=null; }
    const btnTryImg2 = document.getElementById('btn-try'); if (btnTryImg2) { btnTryImg2.style.display='none'; btnTryImg2.onclick=null; }
    const btnWorldMapGoLV = document.getElementById('btn-worldmap-go'); if (btnWorldMapGoLV) { btnWorldMapGoLV.style.display='none'; btnWorldMapGoLV.onclick=null; }
    const consBgReset = document.getElementById('consequence-container'); if (consBgReset) { consBgReset.style.display='none'; }

    const goTitleHideLV = document.getElementById('go-title'); if (goTitleHideLV) goTitleHideLV.style.display='none';

    // Get zone configuration
    const zoneId = this.registry.get('zone') || 1;
    const zoneConfig = ZoneConfig.find(z => z.id === zoneId) || ZoneConfig[0];

    // Background via DOM image - use zone-specific background
    const levelBgEl = document.getElementById('level-bg');
    if (levelBgEl) {
      // Set the appropriate background for this zone
      const bgMap = {
        1: 'assets/backgrounds/level_01_background.png',
        2: 'assets/backgrounds/level_02_background.png',
        3: 'assets/backgrounds/level_03_background.png'
      };
      levelBgEl.src = bgMap[zoneId] || bgMap[1];
      levelBgEl.style.display = 'block';
    }

    // Show and update DOM-based HUD
    const gameHud = document.getElementById('game-hud');
    if (gameHud) gameHud.style.display = 'block';

    const hudHealth = document.getElementById('hud-health');
    const hudPoints = document.getElementById('hud-points');
    const hudLevel = document.getElementById('hud-level');
    const hudStage = document.getElementById('hud-stage');
    const hudZone = document.getElementById('hud-zone');

    if (hudHealth) hudHealth.textContent = 'Health: ' + this.registry.get('health');
    if (hudPoints) hudPoints.textContent = 'Points: ' + this.registry.get('points');
    if (hudLevel) hudLevel.textContent = 'Level: ' + this.registry.get('level');
    if (hudStage) hudStage.textContent = 'Stage: ' + this.registry.get('stage');
    if (hudZone) {
      hudZone.textContent = zoneConfig.name;
      hudZone.style.color = zoneConfig.color;
    }

    // Show point multiplier if active
    if (this.pointMultiplier > 1) {
      this.add.text(20, 80, '2x POINTS ACTIVE!', {font:'16px Arial', fill:'#FF9800'});
    }

    // Setup item bar
    this.setupItemBar();
    // Moved down by 200px (from y=100 to y=300) and doubled font size (24px -> 48px)
    this.promptText = this.add.text(400,300, '', {font:'48px Arial', fill:'#fff', align:'center', wordWrap:{width:1400}}).setOrigin(0.5);

    // Menu button (DOM image)
    const domMenuBtn2 = document.getElementById('btn-menu');
    if (domMenuBtn2) {
      domMenuBtn2.style.display = 'block';
      // Bottom-right placement at 50% scale during gameplay
      domMenuBtn2.style.right = '16px';
      domMenuBtn2.style.bottom = '16px';
      domMenuBtn2.style.left = '';
      domMenuBtn2.style.top = '';
      domMenuBtn2.style.transformOrigin = 'bottom right';
      domMenuBtn2.style.transform = 'scale(0.5)';
      domMenuBtn2.onclick = () => this.scene.start('MainMenuScene');
    }

    // Quit button (DOM image) bottom-right, offset from Menu
    const btnQuitLV = document.getElementById('btn-quit');
    if (btnQuitLV) {
      btnQuitLV.style.display = 'block';
      btnQuitLV.style.right = '196px';
      btnQuitLV.style.bottom = '16px';
      btnQuitLV.style.left = '';
      btnQuitLV.style.top = '';
      btnQuitLV.style.transformOrigin = 'bottom right';
      btnQuitLV.style.transform = 'scale(0.5)';
      btnQuitLV.onclick = () => window.close();
    }

    // Set up DOM-based choice frames
    this.setupChoiceFrames();

    // Next level uses DOM image button (btn-next). It will be shown on level completion.

    // Start
    this.generateJunctions();
    this.junctionIndex = 0;
    this.showJunction();
  }

  setupItemBar() {
    const user = getUser();
    if (!user) return;

    const itemBar = document.getElementById('item-bar');
    if (!itemBar) return;

    const consumables = user.inventory.consumables;
    let hasAnyItems = false;

    // HP Small button
    const hpSmallBtn = document.getElementById('item-hp-small');
    if (hpSmallBtn) {
      if (consumables.hp_small > 0) {
        hpSmallBtn.style.display = 'inline-block';
        hpSmallBtn.textContent = `+3 HP (${consumables.hp_small})`;
        hpSmallBtn.onclick = () => this.useConsumable('hp_small', 3);
        hasAnyItems = true;
      } else {
        hpSmallBtn.style.display = 'none';
      }
    }

    // HP Large button
    const hpLargeBtn = document.getElementById('item-hp-large');
    if (hpLargeBtn) {
      if (consumables.hp_large > 0) {
        hpLargeBtn.style.display = 'inline-block';
        hpLargeBtn.textContent = `+7 HP (${consumables.hp_large})`;
        hpLargeBtn.onclick = () => this.useConsumable('hp_large', 7);
        hasAnyItems = true;
      } else {
        hpLargeBtn.style.display = 'none';
      }
    }

    // Point Boost button
    const pointBoostBtn = document.getElementById('item-point-boost');
    if (pointBoostBtn) {
      if (consumables.point_boost > 0 && this.pointMultiplier === 1) {
        pointBoostBtn.style.display = 'inline-block';
        pointBoostBtn.textContent = `2x Points (${consumables.point_boost})`;
        pointBoostBtn.onclick = () => this.useConsumable('point_boost', 2);
        hasAnyItems = true;
      } else {
        pointBoostBtn.style.display = 'none';
      }
    }

    // Items used counter
    const itemsUsedEl = document.getElementById('items-used');
    if (itemsUsedEl) {
      itemsUsedEl.textContent = `(${this.itemsUsedThisLevel}/3 used)`;
    }

    // Show or hide item bar
    if (hasAnyItems) {
      itemBar.style.display = 'block';
    } else {
      itemBar.style.display = 'none';
    }
  }

  useConsumable(itemId, value) {
    if (this.itemsUsedThisLevel >= 3) {
      return; // Max 3 items per level
    }

    const user = getUser();
    if (!user || user.inventory.consumables[itemId] <= 0) return;

    // Deduct item
    user.inventory.consumables[itemId]--;
    saveUser(user);

    // Apply effect
    if (itemId === 'hp_small' || itemId === 'hp_large') {
      this.registry.values.health += value;
      this.updateUI();
    } else if (itemId === 'point_boost') {
      this.pointMultiplier = value;
      this.registry.set('pointMultiplier', value);
      // Show indicator
      this.add.text(20, 80, '2x POINTS ACTIVE!', {font:'16px Arial', fill:'#FF9800'});
    }

    this.itemsUsedThisLevel++;
    this.registry.set('itemsUsedThisLevel', this.itemsUsedThisLevel);

    // Refresh item bar
    this.setupItemBar();
  }

  setupChoiceFrames() {
    // Set up click handlers for DOM choice frames
    const choiceA = document.getElementById('choice-a-frame');
    const choiceB = document.getElementById('choice-b-frame');

    if (choiceA) {
      choiceA.onclick = () => this.handleChoice(0);
      choiceA.onmouseover = () => { choiceA.style.filter = 'brightness(1.2)'; };
      choiceA.onmouseout = () => { choiceA.style.filter = 'none'; };
    }
    if (choiceB) {
      choiceB.onclick = () => this.handleChoice(1);
      choiceB.onmouseover = () => { choiceB.style.filter = 'brightness(1.2)'; };
      choiceB.onmouseout = () => { choiceB.style.filter = 'none'; };
    }
  }

  showQuestionFrames(show) {
    const questionFrame = document.getElementById('question-frame');
    const choicesContainer = document.getElementById('choices-container');
    if (questionFrame) questionFrame.style.display = show ? 'block' : 'none';
    if (choicesContainer) choicesContainer.style.display = show ? 'block' : 'none';
  }

  enableChoiceFrames(enabled) {
    const choiceA = document.getElementById('choice-a-frame');
    const choiceB = document.getElementById('choice-b-frame');
    if (choiceA) {
      choiceA.style.pointerEvents = enabled ? 'auto' : 'none';
      choiceA.style.opacity = enabled ? '1' : '0.6';
    }
    if (choiceB) {
      choiceB.style.pointerEvents = enabled ? 'auto' : 'none';
      choiceB.style.opacity = enabled ? '1' : '0.6';
    }
  }

  generateJunctions() {
    const zoneId = this.registry.get('zone') || 1;
    const selectedDifficulty = this.registry.get('selectedDifficulty') || 1;
    const zoneConfig = ZoneConfig.find(z => z.id === zoneId) || ZoneConfig[0];
    const pool = ZonePrompts[zoneId] || ZonePrompts[1];

    // Calculate combined difficulty multiplier:
    // Base zone multiplier + (selectedDifficulty - 1) * 0.3
    // Zone 1 Diff 1: 1.0, Diff 2: 1.3, Diff 3: 1.6
    // Zone 2 Diff 1: 1.3, Diff 2: 1.6, Diff 3: 1.9
    // Zone 3 Diff 1: 1.6, Diff 2: 1.9, Diff 3: 2.2
    const combinedMultiplier = zoneConfig.difficultyMod + (selectedDifficulty - 1) * 0.3;

    // Apply difficulty modifier to HP costs AND points
    const modifiedPool = pool.map(j => {
      const modified = JSON.parse(JSON.stringify(j)); // Deep clone
      modified.opts = modified.opts.map(opt => {
        // Scale HP loss by combined difficulty (don't scale gains)
        if (opt.hp < 0) {
          opt.hp = Math.floor(opt.hp * combinedMultiplier);
        }
        // Scale points by combined difficulty (more risk = more reward)
        opt.pts = Math.floor(opt.pts * combinedMultiplier);
        return opt;
      });
      return modified;
    });

    Phaser.Utils.Array.Shuffle(modifiedPool);
    // Number of choices based on zone
    this.junctions = modifiedPool.slice(0, zoneConfig.choicesPerLevel);
  }
  showJunction() {
    if (this.registry.get('health') <= 0) return this.scene.start('GameOverScene');
    if (this.junctionIndex >= this.junctions.length) return this.onLevelComplete();
    const j = this.junctions[this.junctionIndex];

    // Update DOM-based question frame
    const questionText = document.getElementById('question-text');
    if (questionText) questionText.textContent = j.prompt;

    // Update DOM-based choice frames
    j.opts.forEach((opt, i) => {
      const pts = (opt.pts >= 0 ? '+' : '') + opt.pts + ' pts';
      const hp = (opt.hp >= 0 ? '+' : '') + opt.hp + ' HP';
      const choiceText = document.getElementById(i === 0 ? 'choice-a-text' : 'choice-b-text');
      if (choiceText) {
        choiceText.innerHTML = `${opt.text}<br><span style="font-size:14px;color:#FFD700;">(${pts}, ${hp})</span>`;
      }
    });

    // Show the frames and enable interaction
    this.showQuestionFrames(true);
    this.enableChoiceFrames(true);

    // Also keep Phaser text as fallback (hidden for now)
    this.promptText.setText(j.prompt).setVisible(false);
  }
  handleChoice(idx) {
    const j = this.junctions[this.junctionIndex], opt = j.opts[idx];

    // Apply point multiplier
    const pointsEarned = Math.floor(opt.pts * this.pointMultiplier);
    this.registry.values.points += pointsEarned;
    this.registry.values.health += opt.hp;

    // Track points earned this level for bonus calculation
    this.levelPointsEarned += pointsEarned;

    // Track damage for perfect level
    if (opt.hp < 0) {
      this.damageTaken += Math.abs(opt.hp);
    }

    // Update user stats and add points immediately to persistent balance
    const user = getUser();
    if (user) {
      user.stats.choicesMade++;
      user.inventory.currency += pointsEarned;
      // Ensure points never go below 0
      if (user.inventory.currency < 0) user.inventory.currency = 0;
      saveUser(user);
    }
    {
      const currentStage = this.registry.get('stage');
      const maxStages = this.junctions.length;
      const nextStage = Math.min(currentStage + 1, maxStages);
      this.registry.set('stage', nextStage);
    }
    this.updateUI();
    // disable choice frames
    this.enableChoiceFrames(false);
    // risk-based consequence
    const risk=opt.pts;
    const randH=Phaser.Math.Between(-risk,Math.floor(risk*0.5));
    const randP=Phaser.Math.Between(-Math.ceil(risk*0.5),Math.ceil(risk*0.5));
    const desc=Phaser.Utils.Array.GetRandom(this.consequences);
    this.showConsequencePopup(desc,randH,randP);
  }
  showConsequencePopup(desc, randH, randP) {
    // Hide question and choice frames while popup is active
    this.showQuestionFrames(false);
    this.promptText.setVisible(false);
    this.promptText.setAlpha(0);
    const btnNextHide = document.getElementById('btn-next');
    if (btnNextHide) { btnNextHide.style.display='none'; btnNextHide.onclick=null; }

    // Show consequence frame
    const consContainer = document.getElementById('consequence-container');
    if (consContainer) consContainer.style.display = 'block';

    // Hide menu and quit buttons while consequence is showing
    const btnMenu = document.getElementById('btn-menu');
    const btnQuit = document.getElementById('btn-quit');
    if (btnMenu) btnMenu.style.display = 'none';
    if (btnQuit) btnQuit.style.display = 'none';

    // Populate consequence text using DOM elements
    const consText = document.getElementById('consequence-text');
    const consStats = document.getElementById('consequence-stats');
    if (consText) consText.textContent = desc;
    if (consStats) consStats.textContent = `Health: ${randH>=0?'+':''}${randH}  Points: ${randP>=0?'+':''}${randP}`;

    // Move continue button into consequence frame
    const btnContainer = document.getElementById('consequence-btn-container');
    const btnContinue = document.getElementById('btn-continue');
    if (btnContinue && btnContainer) {
      btnContainer.appendChild(btnContinue);
      btnContinue.style.display = 'block';
      btnContinue.style.position = 'relative';
      btnContinue.style.left = '';
      btnContinue.style.top = '';
      btnContinue.style.transform = 'scale(0.8)';
      btnContinue.style.transformOrigin = 'center';
      btnContinue.onclick = () => {
        // Apply effects (with point multiplier)
        this.registry.values.points += Math.floor(randP * this.pointMultiplier);
        this.registry.values.health += randH;

        // Track consequence damage
        if (randH < 0) {
          this.damageTaken += Math.abs(randH);
        }

        this.updateUI();
        // Cleanup and proceed
        document.body.appendChild(btnContinue);
        btnContinue.style.position = 'fixed';
        btnContinue.style.display = 'none';
        btnContinue.onclick = null;
        if (consContainer) consContainer.style.display = 'none';
        // Restore menu and quit buttons
        if (btnMenu) btnMenu.style.display = 'block';
        if (btnQuit) btnQuit.style.display = 'block';
        this.promptText.setAlpha(1);
        this.promptText.setVisible(true);
        this.junctionIndex++;
        this.showJunction();
      };
    }
  }
  updateUI() {
    const hudHealth = document.getElementById('hud-health');
    const hudPoints = document.getElementById('hud-points');
    const hudLevel = document.getElementById('hud-level');
    const hudStage = document.getElementById('hud-stage');

    if (hudHealth) hudHealth.textContent = 'Health: ' + this.registry.get('health');
    if (hudPoints) hudPoints.textContent = 'Points: ' + this.registry.get('points');
    if (hudLevel) hudLevel.textContent = 'Level: ' + this.registry.get('level');
    if (hudStage) hudStage.textContent = 'Stage: ' + this.registry.get('stage');
  }
  onLevelComplete() {
    const currentLevel = this.registry.get('level');
    const zoneId = this.registry.get('zone') || 1;
    const isPerfect = this.damageTaken === 0;
    const currentScore = this.registry.get('points');

    console.log('[DEBUG] onLevelComplete called - Zone:', zoneId, 'Level:', currentLevel);

    // Save user progress
    const user = getUser();
    if (user) {
      // Check if this level was already completed
      const levelKey = `${zoneId}-${currentLevel}`;
      const existingHigh = user.progress.highScores[levelKey] || 0;

      if (currentScore > existingHigh) {
        user.progress.highScores[levelKey] = currentScore;
      }

      // Record level completion if not already done
      const alreadyCompleted = user.progress.completedLevels.some(
        l => l.zone === zoneId && l.level === currentLevel
      );
      console.log('[DEBUG] Already completed?', alreadyCompleted, '- Current completedLevels:', JSON.stringify(user.progress.completedLevels));
      if (!alreadyCompleted) {
        user.progress.completedLevels.push({
          zone: zoneId,
          level: currentLevel,
          score: currentScore,
          perfect: isPerfect
        });
        console.log('[DEBUG] Added level', currentLevel, '- New completedLevels:', JSON.stringify(user.progress.completedLevels));
      }

      // Update stats
      if (isPerfect) {
        user.stats.perfectLevels++;
      }

      // Calculate bonus points (zone bonus and perfect bonus)
      // Base points were already added during gameplay in handleChoice
      const zone = ZoneConfig.find(z => z.id === zoneId) || ZoneConfig[0];
      let bonusPoints = 0;

      // Zone bonus: extra points based on zone currencyBonus
      if (zone.currencyBonus > 1.0) {
        bonusPoints += Math.floor(this.levelPointsEarned * (zone.currencyBonus - 1.0));
      }

      // Perfect bonus: 50% extra if no damage taken
      if (isPerfect) {
        bonusPoints += Math.floor(this.levelPointsEarned * 0.5);
      }

      // Add bonus points
      if (bonusPoints > 0) {
        user.inventory.currency += bonusPoints;
      }

      // Track total points earned this level (base + bonus)
      const totalLevelPoints = this.levelPointsEarned + bonusPoints;

      // Check zone completion
      const zoneConfig = ZoneConfig.find(z => z.id === zoneId);
      const zoneLevelsCompleted = user.progress.completedLevels.filter(l => l.zone === zoneId).length;
      const selectedDifficulty = this.registry.get('selectedDifficulty') || 1;
      let isZoneComplete = false;

      // Zone is complete when player just finished the final level (level 5)
      // currentLevel is the level that was just completed
      if (currentLevel >= zoneConfig.levelsRequired) {
        isZoneComplete = true;

        // Initialize zoneCompletions if needed
        if (!user.progress.zoneCompletions) {
          user.progress.zoneCompletions = {};
        }

        // Update highest difficulty completed for this zone
        const currentHighest = user.progress.zoneCompletions[zoneId] || 0;
        if (selectedDifficulty > currentHighest) {
          user.progress.zoneCompletions[zoneId] = selectedDifficulty;
        }

        // Unlock next zone
        const nextZone = ZoneConfig.find(z => z.id === zoneId + 1);
        if (nextZone && user.progress.currentZone < nextZone.id) {
          user.progress.currentZone = nextZone.id;
          user.stats.zonesCompleted++;
        }
      }

      // Check and award achievements
      const newAchievements = checkAchievements(user);
      user.achievements = [...user.achievements, ...newAchievements];

      saveUser(user);

      // Show level complete with points earned
      let completeMsg = `Level Complete!\n+${totalLevelPoints} Points`;
      if (bonusPoints > 0) {
        completeMsg += ` (${bonusPoints} bonus)`;
      }
      if (isPerfect) {
        completeMsg += '\nPERFECT!';
      }
      this.promptText.setText(completeMsg);

      // Store for use in showing popup
      this.isZoneComplete = isZoneComplete;
      this.zoneCompleteZoneId = zoneId;
    } else {
      this.promptText.setText('Level Complete!');
      this.isZoneComplete = false;
    }

    this.registry.values.level += 1;
    this.registry.values.stage = 1;

    // Reset level points tracking for next level
    this.levelPointsEarned = 0;

    // Reset item usage and point multiplier for next level
    this.registry.set('itemsUsedThisLevel', 0);
    this.registry.set('pointMultiplier', 1);

    this.showQuestionFrames(false);

    // Hide item bar on level complete
    const itemBar = document.getElementById('item-bar');
    if (itemBar) itemBar.style.display = 'none';

    // Check if zone is complete - show zone complete popup instead of next level button
    if (this.isZoneComplete) {
      this.showZoneCompletePopup(this.zoneCompleteZoneId);
    } else {
      const btnNextShow = document.getElementById('btn-next');
      if (btnNextShow) {
        btnNextShow.style.display = 'block';
        btnNextShow.style.left = '50%';
        btnNextShow.style.top = '500px';
        btnNextShow.style.transform = 'translateX(-50%)';
        btnNextShow.onclick = () => this.startNextLevel();
      }
    }
    this.updateUI();
  }
  startNextLevel() {
    const btnNextHide2 = document.getElementById('btn-next');
    if (btnNextHide2) { btnNextHide2.style.display='none'; btnNextHide2.onclick=null; }

    // Reset tracking for new level
    this.damageTaken = 0;
    this.startingHealth = this.registry.get('health');
    this.itemsUsedThisLevel = 0;
    this.pointMultiplier = this.registry.get('pointMultiplier') || 1;

    // Re-setup item bar for the new level
    this.setupItemBar();

    this.generateJunctions();
    this.junctionIndex=0;
    this.showJunction();
  }

  showZoneCompletePopup(zoneId) {
    const container = document.getElementById('zone-complete-container');
    const frame = document.getElementById('zone-complete-frame');
    const subtitle = document.getElementById('zone-complete-subtitle');
    const btnContainer = document.getElementById('zone-complete-btn-container');

    if (!container || !frame) return;

    // Determine next zone name or if all zones complete
    const nextZone = ZoneConfig.find(z => z.id === zoneId + 1);
    const isAllComplete = !nextZone;

    if (isAllComplete) {
      subtitle.textContent = 'üéâ All Zones Complete! üéâ';
    } else {
      subtitle.textContent = `${nextZone.name} Unlocked!`;
    }

    // Create continue button
    btnContainer.innerHTML = '';
    const continueBtn = document.createElement('img');
    continueBtn.src = 'assets/buttons/button_continue.png';
    continueBtn.alt = 'Continue';
    continueBtn.style.cssText = 'width:180px;height:auto;cursor:pointer;';
    continueBtn.onclick = () => {
      // Hide popup
      container.style.display = 'none';
      frame.classList.remove('zone-complete-animate');

      if (isAllComplete) {
        // Return to main menu
        this.scene.start('MainMenuScene');
      } else {
        // Start next zone
        this.startNextZone(nextZone.id);
      }
    };
    btnContainer.appendChild(continueBtn);

    // Show container and animate frame
    container.style.display = 'block';
    frame.classList.add('zone-complete-animate');
  }

  startNextZone(nextZoneId) {
    // Hide zone complete popup if visible
    const zoneCompleteContainer = document.getElementById('zone-complete-container');
    if (zoneCompleteContainer) zoneCompleteContainer.style.display = 'none';

    // Set up for new zone (points persist, don't reset)
    this.registry.set('zone', nextZoneId);
    this.registry.set('level', 1);
    this.registry.set('stage', 1);
    this.registry.set('health', 10);
    // Points are persistent - don't reset
    this.registry.set('selectedDifficulty', 1); // Reset to difficulty 1 for new zone
    this.registry.set('pointMultiplier', 1);
    this.registry.set('itemsUsedThisLevel', 0);

    // Restart the LevelScene with new zone
    this.scene.restart();
  }
}

class GameOverScene extends Phaser.Scene {
  constructor(){ super('GameOverScene'); }
  init(){
    const score = this.registry.get('points');
    const high = this.registry.get('highScore') || 0;
    if (score > high) this.registry.set('highScore', score);

    // Update user stats
    const user = getUser();
    if (user) {
      user.stats.totalGames++;
      user.stats.totalDeaths++;
      user.stats.totalPoints += score;

      // Points were already added during gameplay in handleChoice
      // Just show current total points on game over screen
      this.totalPoints = user.inventory.currency;

      // Check survivor achievement
      if (this.registry.get('health') === 1 && !user.achievements.includes('survivor')) {
        user.achievements.push('survivor');
      }

      // Check and award other achievements
      const newAchievements = checkAchievements(user);
      user.achievements = [...new Set([...user.achievements, ...newAchievements])];

      saveUser(user);
    }

    // Reset point multiplier and item tracking
    this.registry.set('pointMultiplier', 1);
    this.registry.set('itemsUsedThisLevel', 0);
  }
  create(){
    // Hide all containers
    hideAllContainers();

    // Hide menu DOM elements that don't belong on this screen
    const domBg = document.getElementById('menu-bg'); if (domBg) domBg.style.display='none';
    const domLogo = document.getElementById('menu-logo'); if (domLogo) domLogo.style.display='none';
    const levelBgHide = document.getElementById('level-bg'); if (levelBgHide) levelBgHide.style.display='none';
    const leaderboardBgHideGO = document.getElementById('leaderboard-container'); if (leaderboardBgHideGO) leaderboardBgHideGO.style.display='none';
    document.body.style.backgroundColor = '';
    const gameOverBgShowGO = document.getElementById('gameover-bg'); if (gameOverBgShowGO) gameOverBgShowGO.style.display='block';
    const btnStart = document.getElementById('btn-start'); if (btnStart) btnStart.style.display='none';
    const btnLeaderboard = document.getElementById('btn-leaderboard'); if (btnLeaderboard) btnLeaderboard.style.display='none';
    const btnContinue = document.getElementById('btn-continue'); if (btnContinue) { btnContinue.style.display='none'; btnContinue.onclick=null; }
    const domMenuBtnX = document.getElementById('btn-menu'); if (domMenuBtnX) { domMenuBtnX.style.display='none'; domMenuBtnX.onclick=null; }
    const btnQuitGOHide = document.getElementById('btn-quit'); if (btnQuitGOHide) { btnQuitGOHide.style.display='none'; btnQuitGOHide.onclick=null; }
    const consBgHideFinal = document.getElementById('consequence-container'); if (consBgHideFinal) consBgHideFinal.style.display='none';

    // Game Over title image (DOM)
    const goTitle = document.getElementById('go-title');
    if (goTitle) {
      goTitle.style.display = 'block';
      goTitle.style.width = 'auto';
      goTitle.style.left = '50%';
      goTitle.style.transform = 'translateX(-50%)';
      goTitle.style.zIndex = '9';
    }

    // Show total points (DOM element for debug outline support)
    const goTotalPoints = document.getElementById('go-total-points');
    if (goTotalPoints && this.totalPoints !== undefined) {
      goTotalPoints.textContent = `Total Points: ${this.totalPoints}`;
      goTotalPoints.style.display = 'block';
      goTotalPoints.style.top = '200px';
    }

    // Get button container and buttons
    const btnContainer = document.getElementById('go-btn-container');
    const btnWorldMapGo = document.getElementById('btn-worldmap-go');
    const btnTry = document.getElementById('btn-try');
    const btnSubmit = document.getElementById('btn-submit');
    const btnMenu = document.getElementById('btn-menu');
    const CONTAINER_WIDTH = 180;

    // Helper to hide all game over buttons and container
    const hideAllGOButtons = () => {
      // Move buttons back to body to preserve them for next game over
      [btnWorldMapGo, btnTry, btnSubmit, btnMenu].forEach(btn => {
        if (btn && btn.parentElement === btnContainer) {
          btn.style.display = 'none';
          btn.style.position = 'fixed';
          btn.onclick = null;
          document.body.appendChild(btn);
        }
      });
      if (btnContainer) btnContainer.style.display = 'none';
      if (goTotalPoints) goTotalPoints.style.display = 'none';
    };

    if (btnContainer) {
      // Clear container and set up
      btnContainer.innerHTML = '';
      btnContainer.style.display = 'flex';
      btnContainer.style.top = '240px';

      // Button order: World Map, Try Again, Submit Score, Menu
      const buttons = [
        { el: btnWorldMapGo, action: () => { hideAllGOButtons(); this.scene.start('WorldMapScene'); } },
        { el: btnTry, action: () => {
          this.registry.set('health', 10);
          this.registry.set('level', 1);
          this.registry.set('stage', 1);
          this.registry.set('pointMultiplier', 1);
          this.registry.set('itemsUsedThisLevel', 0);
          hideAllGOButtons();
          this.scene.start('LevelScene');
        }},
        { el: btnSubmit, action: () => {
          const initials = prompt('Enter initials', 'AAA') || '---';
          const board = getLeaderboard();
          const user = getUser();
          const totalPoints = user ? user.inventory.currency : this.registry.get('points');
          board.push({ initials: initials.slice(0, 3).toUpperCase(), score: totalPoints });
          board.sort((a, b) => b.score - a.score);
          saveLeaderboard(board.slice(0, 10));
          const goBg = document.getElementById('gameover-bg'); if (goBg) goBg.style.display = 'none';
          hideAllGOButtons();
          this.scene.start('LeaderboardScene');
        }},
        { el: btnMenu, action: () => { hideAllGOButtons(); this.scene.start('MainMenuScene'); } }
      ];

      // Add each button to container with uniform width
      buttons.forEach(({ el, action }) => {
        if (el) {
          el.style.position = 'relative';
          el.style.left = '';
          el.style.top = '';
          el.style.right = '';
          el.style.bottom = '';
          el.style.transform = '';
          el.style.width = CONTAINER_WIDTH + 'px';
          el.style.height = 'auto';
          el.style.display = 'block';
          el.style.cursor = 'pointer';
          el.onclick = action;
          btnContainer.appendChild(el);
        }
      });
    }

    // Layout the game over screen elements
    // ========== ADJUST THIS VALUE TO CHANGE TITLE SIZE ==========
    const DESIRED_TITLE_HEIGHT = 200; // Target height for game over title (will scale down if needed)
    // ============================================================

    const layoutGameOver = () => {
      const vh = window.innerHeight;
      const titleEl = document.getElementById('go-title');
      const pointsEl = document.getElementById('go-total-points');
      const containerEl = document.getElementById('go-btn-container');
      if (!titleEl || !pointsEl || !containerEl) return;

      const containerRect = containerEl.getBoundingClientRect();
      if (containerRect.height === 0) {
        setTimeout(layoutGameOver, 50);
        return;
      }

      // Fixed spacing values
      const titleTop = 30;
      const gapAfterTitle = 10;
      const gapAfterPoints = 20;
      const pointsHeight = 30;
      const bottomMargin = 20;

      // Calculate how much space we need for everything except title
      const fixedSpace = titleTop + gapAfterTitle + pointsHeight + gapAfterPoints + containerRect.height + bottomMargin;

      // Calculate max title height that still fits everything on screen
      const maxTitleHeight = vh - fixedSpace;

      // Use desired height or scale down to fit
      const titleHeight = Math.min(DESIRED_TITLE_HEIGHT, Math.max(60, maxTitleHeight));

      // Position all elements
      titleEl.style.top = titleTop + 'px';
      titleEl.style.height = titleHeight + 'px';

      const pointsTop = titleTop + titleHeight + gapAfterTitle;
      pointsEl.style.top = pointsTop + 'px';

      const containerTop = pointsTop + pointsHeight + gapAfterPoints;
      containerEl.style.top = containerTop + 'px';
    };

    setTimeout(layoutGameOver, 0);
    setTimeout(layoutGameOver, 150);
  }
}

class LeaderboardScene extends Phaser.Scene {
  constructor(){ super('LeaderboardScene'); }
  create(){
    // Hide all containers
    hideAllContainers();

    // Hide menu DOM/logo/buttons and any popup DOM controls
    const domBg = document.getElementById('menu-bg'); if (domBg) domBg.style.display='none';
    const domLogo = document.getElementById('menu-logo'); if (domLogo) domLogo.style.display='none';
    const levelBgHide = document.getElementById('level-bg'); if (levelBgHide) levelBgHide.style.display='none';
    const gameOverBgHideLB = document.getElementById('gameover-bg'); if (gameOverBgHideLB) gameOverBgHideLB.style.display='none';
    const btnStart = document.getElementById('btn-start'); if (btnStart) btnStart.style.display='none';
    const btnLeaderboard = document.getElementById('btn-leaderboard'); if (btnLeaderboard) btnLeaderboard.style.display='none';
    const btnContinue = document.getElementById('btn-continue'); if (btnContinue) { btnContinue.style.display='none'; btnContinue.onclick=null; }
    const domMenuBtn = document.getElementById('btn-menu'); if (domMenuBtn) { domMenuBtn.style.display='none'; domMenuBtn.onclick=null; }
    const btnSubmitImgLB = document.getElementById('btn-submit'); if (btnSubmitImgLB) { btnSubmitImgLB.style.display='none'; btnSubmitImgLB.onclick=null; }
    const btnTryImgLB = document.getElementById('btn-try'); if (btnTryImgLB) { btnTryImgLB.style.display='none'; btnTryImgLB.onclick=null; }
    const btnWorldMapGoLB = document.getElementById('btn-worldmap-go'); if (btnWorldMapGoLB) { btnWorldMapGoLB.style.display='none'; btnWorldMapGoLB.onclick=null; }
    const consBgHideLB = document.getElementById('consequence-container'); if (consBgHideLB) consBgHideLB.style.display='none';
    const goTitleHideLB2 = document.getElementById('go-title'); if (goTitleHideLB2) goTitleHideLB2.style.display='none';
    // Hide game over container (buttons are handled by hideAllContainers)
    const goBtnContainerLB = document.getElementById('go-btn-container'); if (goBtnContainerLB) goBtnContainerLB.style.display='none';
    const goTotalPointsLB = document.getElementById('go-total-points'); if (goTotalPointsLB) goTotalPointsLB.style.display='none';

    // Hide all main menu buttons
    const btnWorldMap = document.getElementById('btn-worldmap'); if (btnWorldMap) btnWorldMap.style.display='none';
    const btnShop = document.getElementById('btn-shop'); if (btnShop) btnShop.style.display='none';
    const btnProfile = document.getElementById('btn-profile'); if (btnProfile) btnProfile.style.display='none';
    const btnLogout = document.getElementById('btn-logout'); if (btnLogout) btnLogout.style.display='none';
    const btnQuitHide = document.getElementById('btn-quit'); if (btnQuitHide) btnQuitHide.style.display='none';

    // Hide welcome and points displays
    const welcomeDisplay = document.getElementById('menu-welcome-display'); if (welcomeDisplay) welcomeDisplay.style.display='none';
    const pointsDisplay = document.getElementById('menu-points-display'); if (pointsDisplay) pointsDisplay.style.display='none';

    // Set dark background and show leaderboard container
    document.body.style.backgroundColor = '#222';

    // Show leaderboard container (frame is inside)
    const leaderboardContainer = document.getElementById('leaderboard-container');
    if (leaderboardContainer) leaderboardContainer.style.display = 'block';

    // Populate entries using DOM elements (max 10 entries to fit in frame)
    const entriesContainer = document.getElementById('leaderboard-entries');
    if (entriesContainer) {
      entriesContainer.innerHTML = ''; // Clear previous entries
      const board = getLeaderboard().slice(0, 10); // Limit to top 10
      board.forEach((e, i) => {
        const entry = document.createElement('div');
        entry.id = `leaderboard-entry-${i}`;
        entry.style.cssText = 'display:flex;justify-content:space-between;font-family:Arial,sans-serif;font-size:clamp(14px, 2.5vh, 24px);color:#fff;flex-shrink:0;';
        entry.innerHTML = `<span id="leaderboard-entry-${i}-name">${i+1}. ${e.initials}</span><span id="leaderboard-entry-${i}-score">${e.score}</span>`;
        entriesContainer.appendChild(entry);
      });
    }

    // Back button (Menu button) - inside the frame's safe area
    const btnContainer = document.getElementById('leaderboard-btn-container');
    const domMenuBtnLB = document.getElementById('btn-menu');
    if (domMenuBtnLB && btnContainer) {
      // Move button into the leaderboard frame
      btnContainer.appendChild(domMenuBtnLB);
      domMenuBtnLB.style.display = 'block';
      domMenuBtnLB.style.position = 'relative';
      domMenuBtnLB.style.left = '';
      domMenuBtnLB.style.top = '';
      domMenuBtnLB.style.right = '';
      domMenuBtnLB.style.bottom = '';
      domMenuBtnLB.style.transform = 'scale(0.5)';
      domMenuBtnLB.style.transformOrigin = 'center';
      domMenuBtnLB.onclick = () => {
        // Move button back to body before hiding
        document.body.appendChild(domMenuBtnLB);
        domMenuBtnLB.style.display = 'none';
        domMenuBtnLB.style.position = 'fixed';
        domMenuBtnLB.onclick = null;
        const lbContainer = document.getElementById('leaderboard-container');
        if (lbContainer) lbContainer.style.display = 'none';
        this.scene.start('MainMenuScene');
      };
    }
  }
}

// =====================================================
// WORLD MAP SCENE
// =====================================================
class WorldMapScene extends Phaser.Scene {
  constructor() { super('WorldMapScene'); }

  create() {
    // Hide all DOM elements
    hideAllContainers();
    const domBg = document.getElementById('menu-bg'); if (domBg) domBg.style.display = 'none';
    const domLogo = document.getElementById('menu-logo'); if (domLogo) domLogo.style.display = 'none';
    const levelBg = document.getElementById('level-bg'); if (levelBg) levelBg.style.display = 'none';
    const leaderboardBg = document.getElementById('leaderboard-container'); if (leaderboardBg) leaderboardBg.style.display = 'none';
    const gameOverBg = document.getElementById('gameover-bg'); if (gameOverBg) gameOverBg.style.display = 'none';
    const consBg = document.getElementById('consequence-container'); if (consBg) consBg.style.display = 'none';
    const goTitle = document.getElementById('go-title'); if (goTitle) goTitle.style.display = 'none';

    // Hide all buttons
    const buttons = ['btn-worldmap', 'btn-leaderboard', 'btn-shop', 'btn-profile', 'btn-logout', 'btn-continue', 'btn-next', 'btn-menu', 'btn-submit', 'btn-try', 'btn-worldmap-go', 'btn-quit'];
    buttons.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) { btn.style.display = 'none'; btn.onclick = null; }
    });

    // Show world map background and container
    const worldmapBg = document.getElementById('worldmap-bg');
    if (worldmapBg) worldmapBg.style.display = 'block';
    const worldmapContainer = document.getElementById('worldmap-container');
    if (worldmapContainer) worldmapContainer.style.display = 'block';

    // Get user data
    const user = getUser();
    const unlockedZone = user ? user.progress.currentZone : 1;

    // Store selected zone for start button
    this.selectedZone = null;

    // Setup zone markers with click handlers
    const zoneMarkers = document.querySelectorAll('.zone-marker');
    zoneMarkers.forEach(marker => {
      const zoneId = parseInt(marker.getAttribute('data-zone'));
      const zone = ZoneConfig.find(z => z.id === zoneId);
      if (!zone) return;

      // Check zone unlock status
      const prevZone = ZoneConfig.find(z => z.id === zone.id - 1);
      let isUnlocked = zone.id === 1;
      if (prevZone && user) {
        const prevZoneCompleted = user.progress.completedLevels.filter(l => l.zone === prevZone.id).length;
        isUnlocked = prevZoneCompleted >= zone.unlockRequirement || zone.id <= unlockedZone;
      }

      // Update marker appearance based on lock status
      const icon = marker.querySelector('span');
      if (!isUnlocked) {
        marker.style.opacity = '0.5';
        marker.style.cursor = 'not-allowed';
        if (icon) icon.textContent = 'üîí';
      }

      // Hover effects
      marker.onmouseover = () => {
        marker.style.transform = 'scale(1.1)';
        marker.style.borderColor = '#FFD700';
      };
      marker.onmouseout = () => {
        marker.style.transform = 'scale(1)';
        marker.style.borderColor = this.selectedZone === zoneId ? '#FFD700' : '#B8860B';
      };

      // Click to show zone details
      marker.onclick = () => {
        this.showZoneDetails(zone, user, isUnlocked);
        // Highlight selected marker
        zoneMarkers.forEach(m => m.style.borderColor = '#B8860B');
        marker.style.borderColor = '#FFD700';
        this.selectedZone = zoneId;
      };
    });

    // Setup start button in detail panel
    const startBtn = document.getElementById('btn-zone-start');
    if (startBtn) {
      startBtn.onclick = () => {
        if (this.selectedZone) {
          worldmapContainer.style.display = 'none';
          this.registry.set('zone', this.selectedZone);
          this.registry.set('health', 10);
          // Points are persistent - load from user's balance in LevelScene init
          this.registry.set('level', 1);
          this.registry.set('stage', 1);
          this.registry.set('pointMultiplier', 1);
          this.registry.set('itemsUsedThisLevel', 0);
          this.registry.set('selectedDifficulty', this.selectedDifficulty || 1);
          // Clear registry points so it gets reloaded from user in LevelScene
          this.registry.set('points', undefined);
          this.scene.start('LevelScene');
        }
      };
    }

    // Setup back button
    const backBtn = document.getElementById('btn-worldmap-back');
    if (backBtn) {
      backBtn.onclick = () => {
        worldmapContainer.style.display = 'none';
        const detailPanel = document.getElementById('zone-detail-frame');
        if (detailPanel) detailPanel.style.display = 'none';
        this.scene.start('MainMenuScene');
      };
    }

    // Auto-select first unlocked zone
    const firstMarker = document.querySelector('.zone-marker[data-zone="1"]');
    if (firstMarker) firstMarker.click();
  }

  showZoneDetails(zone, user, isUnlocked) {
    const panel = document.getElementById('zone-detail-frame');
    if (!panel) return;

    // Get completion stats
    let levelsCompleted = 0;
    let zoneCompletions = 0; // Highest difficulty completed
    if (user) {
      levelsCompleted = user.progress.completedLevels.filter(l => l.zone === zone.id).length;
      // Initialize zoneCompletions if needed
      if (!user.progress.zoneCompletions) {
        user.progress.zoneCompletions = {};
      }
      zoneCompletions = user.progress.zoneCompletions[zone.id] || 0;
      console.log('[DEBUG] showZoneDetails - Zone:', zone.id, 'completedLevels:', JSON.stringify(user.progress.completedLevels), 'Count for this zone:', levelsCompleted, 'Zone completions:', zoneCompletions);
    }

    // Update panel content
    document.getElementById('zone-detail-name').textContent = zone.name;
    document.getElementById('zone-detail-desc').textContent = zone.description;

    // Difficulty stars (base zone difficulty)
    const diffStars = '‚≠ê'.repeat(Math.ceil(zone.difficultyMod));
    document.getElementById('zone-detail-difficulty').textContent = diffStars + ` (${zone.difficultyMod}x base)`;

    document.getElementById('zone-detail-choices').textContent = `${zone.choicesPerLevel} choices per level`;

    // Progress bar
    const progressPercent = (levelsCompleted / zone.levelsRequired) * 100;
    document.getElementById('zone-detail-progress-bar').style.width = `${Math.min(progressPercent, 100)}%`;
    document.getElementById('zone-detail-progress-text').textContent = `${levelsCompleted}/${zone.levelsRequired} Levels Completed`;

    // Setup difficulty selector
    const difficultySelector = document.getElementById('zone-difficulty-selector');
    const difficultyMultiplierText = document.getElementById('zone-difficulty-multiplier');
    const difficultyBtns = document.querySelectorAll('.difficulty-btn');

    if (isUnlocked && difficultySelector) {
      difficultySelector.style.display = 'block';

      // Default selected difficulty to 1
      this.selectedDifficulty = 1;

      // Update difficulty buttons
      difficultyBtns.forEach(btn => {
        const diff = parseInt(btn.getAttribute('data-difficulty'));

        // Difficulty unlock logic:
        // Diff 1: Always available once zone unlocked
        // Diff 2: Unlocked after completing zone once (zoneCompletions >= 1)
        // Diff 3: Unlocked after completing zone at Diff 2 (zoneCompletions >= 2)
        const isUnlockedDiff = diff <= zoneCompletions + 1;

        // Reset classes
        btn.classList.remove('selected', 'locked');

        if (!isUnlockedDiff) {
          btn.classList.add('locked');
          btn.innerHTML = 'üîí';
        } else {
          btn.textContent = diff;
          if (diff === 1) {
            btn.classList.add('selected');
          }
        }

        btn.onclick = () => {
          if (!isUnlockedDiff) return;

          // Update selection
          difficultyBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          this.selectedDifficulty = diff;

          // Update multiplier display
          const multiplier = zone.difficultyMod + (diff - 1) * 0.3;
          difficultyMultiplierText.textContent = `${multiplier.toFixed(1)}x Multiplier`;
        };
      });

      // Set initial multiplier display
      const initialMultiplier = zone.difficultyMod + (this.selectedDifficulty - 1) * 0.3;
      difficultyMultiplierText.textContent = `${initialMultiplier.toFixed(1)}x Multiplier`;
    } else if (difficultySelector) {
      difficultySelector.style.display = 'none';
    }

    // Lock status
    const lockedDiv = document.getElementById('zone-detail-locked');
    const startBtn = document.getElementById('btn-zone-start');
    if (isUnlocked) {
      lockedDiv.style.display = 'none';
      startBtn.style.display = 'block';
      startBtn.style.opacity = '1';
      startBtn.style.cursor = 'pointer';
    } else {
      lockedDiv.style.display = 'block';
      startBtn.style.display = 'block';
      startBtn.style.opacity = '0.4';
      startBtn.style.cursor = 'not-allowed';
    }

    // Show panel
    panel.style.display = 'block';
  }
}

// =====================================================
// SHOP SCENE
// =====================================================
class ShopScene extends Phaser.Scene {
  constructor() { super('ShopScene'); }

  create() {
    // Hide all DOM elements
    hideAllContainers();
    const domBg = document.getElementById('menu-bg'); if (domBg) domBg.style.display = 'none';
    const domLogo = document.getElementById('menu-logo'); if (domLogo) domLogo.style.display = 'none';
    const levelBg = document.getElementById('level-bg'); if (levelBg) levelBg.style.display = 'none';
    const leaderboardBg = document.getElementById('leaderboard-container'); if (leaderboardBg) leaderboardBg.style.display = 'none';
    const gameOverBg = document.getElementById('gameover-bg'); if (gameOverBg) gameOverBg.style.display = 'none';

    // Hide all buttons
    const buttons = ['btn-worldmap', 'btn-leaderboard', 'btn-shop', 'btn-profile', 'btn-logout', 'btn-continue', 'btn-next', 'btn-menu', 'btn-submit', 'btn-try', 'btn-worldmap-go', 'btn-quit'];
    buttons.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) { btn.style.display = 'none'; btn.onclick = null; }
    });

    // Show shop background and container
    const shopBg = document.getElementById('shop-bg');
    if (shopBg) shopBg.style.display = 'block';
    const shopContainer = document.getElementById('shop-container');
    if (shopContainer) shopContainer.style.display = 'block';

    this.currentTab = 'cosmetics';
    this.currentPage = 0;
    this.itemsPerPage = 6; // 2 rows of 3 items
    this.renderShop();

    // Setup tabs
    const tabCosmetics = document.getElementById('tab-cosmetics');
    const tabConsumables = document.getElementById('tab-consumables');

    if (tabCosmetics) {
      tabCosmetics.onclick = () => {
        this.currentTab = 'cosmetics';
        this.currentPage = 0; // Reset to first page when switching tabs
        tabCosmetics.style.background = '#ffd700';
        tabCosmetics.style.color = '#000';
        tabConsumables.style.background = '#555';
        tabConsumables.style.color = '#fff';
        this.renderShop();
      };
    }

    if (tabConsumables) {
      tabConsumables.onclick = () => {
        this.currentTab = 'consumables';
        this.currentPage = 0; // Reset to first page when switching tabs
        tabConsumables.style.background = '#ffd700';
        tabConsumables.style.color = '#000';
        tabCosmetics.style.background = '#555';
        tabCosmetics.style.color = '#fff';
        this.renderShop();
      };
    }

    // Setup pagination buttons
    const prevBtn = document.getElementById('shop-prev');
    const nextBtn = document.getElementById('shop-next');

    if (prevBtn) {
      prevBtn.onclick = () => {
        if (this.currentPage > 0) {
          this.currentPage--;
          this.renderShop();
        }
      };
    }

    if (nextBtn) {
      nextBtn.onclick = () => {
        const items = this.currentTab === 'cosmetics' ? ShopItems.cosmetics : ShopItems.consumables;
        const totalPages = Math.ceil(items.length / this.itemsPerPage);
        if (this.currentPage < totalPages - 1) {
          this.currentPage++;
          this.renderShop();
        }
      };
    }

    // Setup back button
    const backBtn = document.getElementById('btn-shop-back');
    if (backBtn) {
      backBtn.onclick = () => {
        shopContainer.style.display = 'none';
        this.scene.start('MainMenuScene');
      };
    }
  }

  renderShop() {
    const user = getUser();
    if (!user) return;

    // Update points display with icon
    const pointsEl = document.getElementById('shop-points');
    if (pointsEl) {
      pointsEl.innerHTML = `<img src="assets/icons/icon_currency.png" alt="Points" title="Points" style="width:28px;height:28px;vertical-align:middle;margin-right:8px;"/>${user.inventory.currency} Points`;
    }

    // Get items grid container
    const itemsGrid = document.getElementById('shop-items-grid');
    if (!itemsGrid) return;

    itemsGrid.innerHTML = '';

    // Get the items for current tab
    const allItems = this.currentTab === 'cosmetics' ? ShopItems.cosmetics : ShopItems.consumables;
    const totalPages = Math.ceil(allItems.length / this.itemsPerPage);

    // Ensure current page is valid
    if (this.currentPage >= totalPages) this.currentPage = Math.max(0, totalPages - 1);

    // Get items for current page
    const startIndex = this.currentPage * this.itemsPerPage;
    const pageItems = allItems.slice(startIndex, startIndex + this.itemsPerPage);

    // Update pagination display
    const pageInfo = document.getElementById('shop-page-info');
    const prevBtn = document.getElementById('shop-prev');
    const nextBtn = document.getElementById('shop-next');

    if (pageInfo) {
      pageInfo.textContent = `Page ${this.currentPage + 1} / ${Math.max(1, totalPages)}`;
    }
    if (prevBtn) {
      prevBtn.style.opacity = this.currentPage > 0 ? '1' : '0.4';
      prevBtn.style.cursor = this.currentPage > 0 ? 'pointer' : 'not-allowed';
    }
    if (nextBtn) {
      nextBtn.style.opacity = this.currentPage < totalPages - 1 ? '1' : '0.4';
      nextBtn.style.cursor = this.currentPage < totalPages - 1 ? 'pointer' : 'not-allowed';
    }

    if (this.currentTab === 'cosmetics') {
      pageItems.forEach(item => {
        const isOwned = user.inventory.cosmetics.includes(item.id);
        const isEquipped = user.equipped.trolleyAppearance === item.id;
        const canAfford = user.inventory.currency >= item.price;

        const itemCard = document.createElement('div');
        itemCard.style.cssText = `
          display: inline-block;
          width: 180px;
          margin: 6px;
          padding: 12px;
          background: rgba(255,255,255,0.1);
          border-radius: 10px;
          text-align: center;
          vertical-align: top;
        `;

        // Image preview (with fallback to color)
        const preview = document.createElement('div');
        preview.style.cssText = `
          width: 140px;
          height: 75px;
          margin: 0 auto 8px;
          background: ${item.preview ? `url('${item.preview}') center/contain no-repeat` : item.color};
          border-radius: 5px;
          border: 3px solid ${isEquipped ? '#ffd700' : 'transparent'};
        `;

        // Name
        const name = document.createElement('div');
        name.style.cssText = 'color: #fff; font-family: Arial; font-size: 13px; margin-bottom: 4px;';
        name.textContent = item.name;

        // Price/Status
        const status = document.createElement('div');
        status.style.cssText = 'color: #ffd700; font-family: Arial; font-size: 11px; margin-bottom: 8px;';
        if (isOwned) {
          status.textContent = isEquipped ? 'EQUIPPED' : 'OWNED';
          status.style.color = isEquipped ? '#4CAF50' : '#888';
        } else {
          status.textContent = `üí∞ ${item.price}`;
        }

        // Button
        const btn = document.createElement('button');
        btn.style.cssText = `
          padding: 6px 14px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-family: Arial;
          font-size: 11px;
        `;

        if (isOwned) {
          if (isEquipped) {
            btn.textContent = 'Equipped';
            btn.style.background = '#666';
            btn.style.color = '#aaa';
            btn.style.cursor = 'default';
          } else {
            btn.textContent = 'Equip';
            btn.style.background = '#4CAF50';
            btn.style.color = '#fff';
            btn.onclick = () => {
              user.equipped.trolleyAppearance = item.id;
              saveUser(user);
              this.renderShop();
            };
          }
        } else {
          btn.textContent = 'Buy';
          btn.style.background = canAfford ? '#ffd700' : '#666';
          btn.style.color = canAfford ? '#000' : '#aaa';
          btn.style.cursor = canAfford ? 'pointer' : 'not-allowed';
          if (canAfford) {
            btn.onclick = () => {
              // Re-check user can still afford (in case of race conditions)
              const currentUser = getUser();
              if (!currentUser || currentUser.inventory.currency < item.price) {
                this.renderShop();
                return;
              }
              currentUser.inventory.currency -= item.price;
              // Ensure points never go below 0
              if (currentUser.inventory.currency < 0) currentUser.inventory.currency = 0;
              currentUser.inventory.cosmetics.push(item.id);
              // Check collector achievement
              const newAchievements = checkAchievements(currentUser);
              currentUser.achievements = [...new Set([...currentUser.achievements, ...newAchievements])];
              saveUser(currentUser);
              this.renderShop();
            };
          }
        }

        itemCard.appendChild(preview);
        itemCard.appendChild(name);
        itemCard.appendChild(status);
        itemCard.appendChild(btn);

        itemsGrid.appendChild(itemCard);
      });
    } else {
      // Consumables tab
      pageItems.forEach(item => {
        const owned = user.inventory.consumables[item.id] || 0;
        const canAfford = user.inventory.currency >= item.price;

        const itemCard = document.createElement('div');
        itemCard.style.cssText = `
          display: inline-block;
          width: 180px;
          margin: 6px;
          padding: 12px;
          background: rgba(255,255,255,0.1);
          border-radius: 10px;
          text-align: center;
          vertical-align: top;
        `;

        // Icon
        const icon = document.createElement('div');
        icon.style.cssText = 'font-size: 28px; margin-bottom: 6px;';
        icon.textContent = item.id === 'hp_small' ? 'üíö' : item.id === 'hp_large' ? 'üíô' : '‚≠ê';

        // Name
        const name = document.createElement('div');
        name.style.cssText = 'color: #fff; font-family: Arial; font-size: 13px; margin-bottom: 4px;';
        name.textContent = item.name;

        // Effect
        const effect = document.createElement('div');
        effect.style.cssText = 'color: #4CAF50; font-family: Arial; font-size: 11px; margin-bottom: 4px;';
        effect.textContent = item.effect;

        // Owned count
        const ownedText = document.createElement('div');
        ownedText.style.cssText = 'color: #888; font-family: Arial; font-size: 10px; margin-bottom: 6px;';
        ownedText.textContent = `Owned: ${owned}`;

        // Price
        const price = document.createElement('div');
        price.style.cssText = 'color: #ffd700; font-family: Arial; font-size: 11px; margin-bottom: 8px;';
        price.textContent = `üí∞ ${item.price}`;

        // Buy button
        const btn = document.createElement('button');
        btn.style.cssText = `
          padding: 6px 14px;
          border: none;
          border-radius: 5px;
          cursor: ${canAfford ? 'pointer' : 'not-allowed'};
          font-family: Arial;
          font-size: 11px;
          background: ${canAfford ? '#ffd700' : '#666'};
          color: ${canAfford ? '#000' : '#aaa'};
        `;
        btn.textContent = 'Buy';
        if (canAfford) {
          btn.onclick = () => {
            // Re-check user can still afford (in case of race conditions)
            const currentUser = getUser();
            if (!currentUser || currentUser.inventory.currency < item.price) {
              this.renderShop();
              return;
            }
            currentUser.inventory.currency -= item.price;
            // Ensure points never go below 0
            if (currentUser.inventory.currency < 0) currentUser.inventory.currency = 0;
            currentUser.inventory.consumables[item.id] = (currentUser.inventory.consumables[item.id] || 0) + 1;
            saveUser(currentUser);
            this.renderShop();
          };
        }

        itemCard.appendChild(icon);
        itemCard.appendChild(name);
        itemCard.appendChild(effect);
        itemCard.appendChild(ownedText);
        itemCard.appendChild(price);
        itemCard.appendChild(btn);

        itemsGrid.appendChild(itemCard);
      });
    }
  }
}

// =====================================================
// PROFILE SCENE
// =====================================================
class ProfileScene extends Phaser.Scene {
  constructor() { super('ProfileScene'); }

  create() {
    // Hide all DOM elements
    hideAllContainers();
    const domBg = document.getElementById('menu-bg'); if (domBg) domBg.style.display = 'none';
    const domLogo = document.getElementById('menu-logo'); if (domLogo) domLogo.style.display = 'none';
    const levelBg = document.getElementById('level-bg'); if (levelBg) levelBg.style.display = 'none';
    const leaderboardBg = document.getElementById('leaderboard-container'); if (leaderboardBg) leaderboardBg.style.display = 'none';
    const gameOverBg = document.getElementById('gameover-bg'); if (gameOverBg) gameOverBg.style.display = 'none';

    // Hide all buttons
    const buttons = ['btn-worldmap', 'btn-leaderboard', 'btn-shop', 'btn-profile', 'btn-logout', 'btn-continue', 'btn-next', 'btn-menu', 'btn-submit', 'btn-try', 'btn-worldmap-go', 'btn-quit'];
    buttons.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) { btn.style.display = 'none'; btn.onclick = null; }
    });

    // Show profile background and container
    const profileBg = document.getElementById('profile-bg');
    if (profileBg) profileBg.style.display = 'block';
    const profileContainer = document.getElementById('profile-container');
    if (profileContainer) profileContainer.style.display = 'block';

    const user = getUser();
    if (!user) {
      this.scene.start('LoginScene');
      return;
    }

    // Render profile content
    const profileContent = document.getElementById('profile-content');
    if (profileContent) {
      profileContent.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 64px;">${user.isGuest ? 'üë§' : 'üéÆ'}</div>
          <h2 style="color: #fff; font-family: Arial; margin: 10px 0;">${user.username}</h2>
          <p style="color: rgba(255,255,255,0.7); font-family: Arial; font-size: 12px;">
            ${user.isGuest ? 'Guest Account' : 'Registered Player'} |
            Joined: ${new Date(user.createdAt).toLocaleDateString()}
          </p>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
          <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
            <div style="color: #ffd700; font-size: 24px; font-family: Arial;">${user.inventory.currency}</div>
            <div style="color: #fff; font-size: 12px; font-family: Arial;">Points</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
            <div style="color: #4CAF50; font-size: 24px; font-family: Arial;">${user.stats.totalGames}</div>
            <div style="color: #fff; font-size: 12px; font-family: Arial;">Games Played</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
            <div style="color: #2196F3; font-size: 24px; font-family: Arial;">${user.stats.totalPoints}</div>
            <div style="color: #fff; font-size: 12px; font-family: Arial;">Total Points</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
            <div style="color: #FF9800; font-size: 24px; font-family: Arial;">${user.stats.choicesMade}</div>
            <div style="color: #fff; font-size: 12px; font-family: Arial;">Choices Made</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
            <div style="color: #E91E63; font-size: 24px; font-family: Arial;">${user.stats.perfectLevels}</div>
            <div style="color: #fff; font-size: 12px; font-family: Arial;">Perfect Levels</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
            <div style="color: #9C27B0; font-size: 24px; font-family: Arial;">${user.progress.completedLevels.length}</div>
            <div style="color: #fff; font-size: 12px; font-family: Arial;">Levels Completed</div>
          </div>
        </div>
      `;
    }

    // Render achievements
    const achievementsContent = document.getElementById('achievements-content');
    if (achievementsContent) {
      let achievementsHTML = '<h3 style="color: #fff; font-family: Arial; margin-bottom: 15px; text-align: center;">Achievements</h3>';
      achievementsHTML += '<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">';

      AchievementDefs.forEach(achievement => {
        const earned = user.achievements.includes(achievement.id);
        achievementsHTML += `
          <div style="
            width: 80px;
            padding: 10px;
            background: ${earned ? 'rgba(76, 175, 80, 0.3)' : 'rgba(0,0,0,0.3)'};
            border-radius: 8px;
            text-align: center;
            opacity: ${earned ? '1' : '0.5'};
          ">
            <div style="font-size: 24px;">${earned ? achievement.icon : 'üîí'}</div>
            <div style="color: #fff; font-size: 10px; font-family: Arial; margin-top: 5px;">${achievement.name}</div>
          </div>
        `;
      });

      achievementsHTML += '</div>';
      achievementsContent.innerHTML = achievementsHTML;
    }

    // Setup back button
    const backBtn = document.getElementById('btn-profile-back');
    if (backBtn) {
      backBtn.onclick = () => {
        profileContainer.style.display = 'none';
        this.scene.start('MainMenuScene');
      };
    }
  }
}

// =====================================================
// GAME INITIALIZATION
// =====================================================
// Check if user exists to determine starting scene
const existingUser = getUser();

// Build scene array with correct starting scene first
const allScenes = [LoginScene, MainMenuScene, LevelScene, GameOverScene, LeaderboardScene, WorldMapScene, ShopScene, ProfileScene];

// If user exists, start with MainMenuScene; otherwise start with LoginScene
const orderedScenes = existingUser
  ? [MainMenuScene, LoginScene, LevelScene, GameOverScene, LeaderboardScene, WorldMapScene, ShopScene, ProfileScene]
  : allScenes;

const config = {
  type: Phaser.AUTO,
  width: 800,
  height: 600,
  transparent: true,
  scene: orderedScenes
};

const game = new Phaser.Game(config);
</script>
</body>
</html>
